<!-- Назначение файла: краткие правила использования Codex. -->

# Инструкции для Codex

- Всю документацию и комментарии пишите на русском языке.
- Отвечайте пользователям тоже исключительно по‑русски.
- Код должен быть лаконичным и понятным, без избыточности.
- В начале каждого файла указывайте его назначение и основные модули.
- Описывайте назначение всех функций и модулей.

## Тесты

Перед коммитом запускайте скрипт:

```bash
./scripts/setup_and_test.sh
```
Он создаёт `.env`, устанавливает зависимости и выполняет тесты и линтеры.

Если нет файла `.env`, создайте его командой `./scripts/create_env_from_exports.sh` на основе `.env.example`. Скрипт корректно обрабатывает специальные символы. Локальный `.env` не добавляйте в репозиторий.
Также запускайте `docker compose config` при наличии `docker-compose.yml`.
CI в GitHub Actions тоже вызывает `scripts/setup_and_test.sh`, поэтому
локальная проверка должна проходить теми же командами.

## Документация

При любом изменении обновляйте файлы `README.md`, `CHANGELOG.md`, `ROADMAP.md` и `AGENTS.md`.
Каталог `bot` содержит актуальный код сервера и веб‑интерфейса. `.env.example` теперь использует строку подключения `mongodb://admin:admin@localhost:27017/agrmcs?authSource=admin`.
README включает раздел о GitHub Actions и необходимости отдельного MongoDB-хоста или Railway CLI.
Добавлена рекомендация запускать `npm --prefix bot run check:mongo` для проверки доступности базы.
Скрипт пытается переподключиться с `authSource=admin`, если получена ошибка аутентификации.
README дополнен описанием `BOT_API_URL` и примером локального telegram-bot-api.
Добавлен краткий абзац о роли `BOT_API_URL` в README.
Docker Compose содержит `healthcheck` для MongoDB с передачей логина и пароля `admin`/`admin`.
 В нём теперь используется команда `mongosh`, что совместимо с новыми версиями образа.
Workflow `docker.yml` поднимает локальный контейнер MongoDB для проверки скриптом `check_mongo.cjs`.
Удалены устаревшие отчёты Lighthouse, файл `extended_tailadmin_guide.md` сокращён.
Добавлен скрипт `create_admin_user.js` для создания администратора по Telegram ID.
Скрипт `create_admin_user.js` теперь использует CommonJS и выводит сообщение при ошибке подключения к MongoDB.
README подчёркивает запуск `npm ci --prefix bot` перед использованием скрипта и демонстрирует пример:
`NODE_PATH=./bot/node_modules node scripts/create_admin_user.js <id> [username]`.
Добавлена верификация через одноразовый код и страница `CodeLogin` в мини‑приложении.
Ссылка на мини‑приложение выдаётся только участникам группы `CHAT_ID` после проверки `getChatMember`.
Добавлена возможность входа по `username` и кнопка открытия @userinfobot. Сайдбар и шапка теперь скрыты до авторизации.
Авторизация по `username` впоследствии удалена, вход осуществляется только по коду.
  - Запуск сервисов переведён на `pm2` версии 6.0.8 для мониторинга и перезапуска.
  - Сообщения о запуске API и бота переведены на русский язык.
  - Маршрут `/tasks/mentioned` размещён выше `/:id`, иначе Express трактует его как параметр и возникает CastError.
  - MongoDB перезапускается Docker Compose при сбое, подключение выполняется с несколькими попытками.
  - Обработчик API возвращает 400 при прерывании запроса (request.aborted)


- Добавлен scheduler.test.js и улучшены параметры перезапуска pm2.
- Функция telegramLogin удалена как устаревшая.
- Dockerfile и Procfile запускают pm2-runtime через npx --prefix bot.
- Добавлен тест errorHandler.test.js.
- Контроллер `reportController` и тест `report.test.js` удалены как неиспользуемые.
- Проверка JWT допускает только алгоритм HS256.
- Ограничено число попыток ввода одноразового кода (до 5) и нормализованы имена загружаемых файлов.
- Логи при запуске сервисов выводят окружение и версию Node для удобства деплоя на Railway.
- Команда `/whoami` выводит ID пользователя и его статус в группе через сервис `userInfoService`.
- Бот работает только в режиме polling, переменная `WEBHOOK_URL` удалена.
- Добавлен скрипт `check_bot_token.sh` для проверки `BOT_TOKEN` перед деплоем.
- Файлы `bot_commands.json` и `bot_messages.json` содержат единственную команду `/start`.
- Мануал `telegram_bot_manual.md` использует скрипт `set_attachment_menu_url.js` для обновления меню.
- В `startBot` добавлен перехват ошибки `bot.launch` с выводом сообщения и завершением процесса.
- Procfile выполняет `scripts/set_bot_commands.sh` для синхронизации меню при
  запуске на Railway.


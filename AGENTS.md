<!-- Назначение файла: правила использования Codex. -->
# Инструкции для Codex

## Стиль
- Все комментарии и документацию пишите на русском языке.
- При общении с пользователями отвечайте исключительно на русском.
- Код должен быть лаконичным и эффективным, избегайте избыточности.
- В начале каждого файла размещайте краткое описание его назначения и основных модулей.
- В комментариях описывайте назначение всех модулей и функций.
- При необходимости ищите в интернете актуальные лучшие решения.

## Тесты
Проект включает автотесты на Jest. Перед коммитом запускайте `npm test --prefix bot` и убеждайтесь, что все проверки проходят. Дополнительно выполняйте `npx eslint bot/src` для проверки кода. Если появляется сообщение `Cannot find module '@eslint/js'`, выполните `npm --prefix bot install`.
Также проверяйте фронтенд: `npm run lint --prefix bot/web`.
## Проверка Docker Compose
Если присутствует `docker-compose.yml`, перед коммитом можно выполнить:
```bash
docker compose config
```
Эта команда проверит корректность файла.
Перед запуском убедитесь, что создан `.env`, иначе появится ошибка о его отсутствии.
При необходимости сформируйте `.env` из экспортированных переменных скриптом
`./scripts/create_env_from_exports.sh`. Скрипт создаёт файл только если его нет,
используя значения из текущего окружения либо данные из `.env.example`.
Всегда запускайте этот скрипт при отсутствии `.env`.
- Все переменные окружения используются через модуль `bot/src/config.js`.

## Деплой
Перед развёртыванием убедитесь, что статический фронтенд собран командой
`npm --prefix bot run build-client` или через `Procfile`.
- Фронтенд теперь расположен в каталоге `bot/web`, Dockerfile и скрипты используют его вместо устаревшего `bot/client`.
- Перед сборкой установите зависимости фронтенда: `npm --prefix bot/web install`
- Если в логах появляется `GET /dashboard/` со статусом `404`, пересоберите фронтенд `npm --prefix bot run build-client` и убедитесь в наличии fallback `app.get('/{*splat}')` в API.
- Для fallback добавлен rate limiter, чтобы исключить перегрузку сервера.
- Маршрут `/api/tasks/:id` тоже ограничен rate limiter (100 запросов за 15 минут).
- При пустой директории `bot/public` сервер сам выполнит `npm run build-client`, однако после обновлений фронтенда сборку лучше запускать вручную.
- После обновления зависимостей повторяйте `npm --prefix bot/web install` и затем `npm --prefix bot run build-client`.
- Для сборки Tailwind используйте плагин `@tailwindcss/postcss` в файле `postcss.config.js`.
- Для форматирования кода фронтенда запустите `npm --prefix bot/web run format`.
  - Для поиска ошибок сохраняйте вывод в лог:
  ```bash
  npm --prefix bot/web install > /tmp/npm_install.log 2>&1 && tail -n 20 /tmp/npm_install.log
  npm --prefix bot run build-client > /tmp/npm_build.log 2>&1 && tail -n 20 /tmp/npm_build.log
  # или используйте ./scripts/build_client.sh
  ```
  Перед запуском `docker compose build` убедитесь, что запущен Docker daemon,
  иначе появится сообщение `Cannot connect to the Docker daemon`.

## Документация
- При добавлении функционала обновляйте раздел «В разработке» в `ROADMAP.md`.
- При любом изменении синхронно обновляйте `README.md`, `CHANGELOG.md`, `ROADMAP.md` и `AGENTS.md`.
- Создавайте задачи через шаблоны в `.github/ISSUE_TEMPLATE` и придерживайтесь `CONTRIBUTING.md`.
- Добавлен шаблон `task.yml` с полями локации, срока, статуса и ответственных.
- Поддерживайте раздел «Обзор текущего состояния» в `README.md`, фиксируя основные плюсы и недостатки проекта.
- В README добавлена секция «Лучшие практики CI/CD», обновляйте её по мере развития.
- При добавлении маршрутов используйте `helmet`, `cors` и валидацию через `express-validator`.
- Страница `/dashboard/tasks` должна получать данные из MongoDB через API.
- Для неё создан компонент `TasksPage` с чеклистом и таймтрекером, API находится по пути `/api/tasks`.
- На этой странице должна быть форма создания новой задачи.
- При успешном создании задачи отображайте `NotificationBar` со статусом `success`.
- Используйте файл `docs/telegram_bot_manual.md` как руководство по настройке команд и вебхуков Telegram-бота.
- Для быстрого обновления меню можно запустить `scripts/set_bot_commands.sh`, файл `scripts/bot_commands.json` содержит пример команд.
- Для расширенных вызовов Telegram применяйте модуль `bot/src/services/telegramApi.js`.
- Бот регистрирует пользователей через `/start` и поддерживает команды `/list_users` и `/add_user` для админов.
- Для компонентов страницы `tasks` используйте путь `../../_components/Section/*`.
- Новые разделы интерфейса: "Проекты", "Отчёты", "Админ" и "Профиль".
- Добавлена страница "Канбан" по пути `/tasks/kanban` для управления задачами.
- Для drag&drop используется `@hello-pangea/dnd`, совместимая с React 19.
- Страница `/tasks` оформлена в стиле TailAdmin `task-list` с фильтрами по статусу и модальным созданием задач.

- Для входа и регистрации добавлены страницы `/login` и `/register`; профиль загружается с `/profile`.
- Логика аутентификации реализована через `AuthContext` с методами `login` и `register`.
- После переноса фронтенда на React проверяйте работоспособность `/dashboard`.
- Компоненты Sidebar, Header и DashboardPage берём из шаблона TailAdmin и поддерживаем в каталоге `bot/web`.
- При доработке интерфейса ориентируйтесь на демо https://react-demo.tailadmin.com.
- Для актуализации стилей используйте архив `free-react-tailwind-admin-dashboard-main.zip` в корне.
- На странице `/dashboard` показывайте актуальные метрики задач, график активности и таблицу последних задач.
- На страницах `Админ`, `Проекты` и `Отчёты` должны присутствовать формы работы с пользователями,
  группами и фильтрами отчётов. Формы отправляют запросы на `/api/users`, `/api/groups`
  и `/api/tasks/report/summary` соответственно.
- Перед запуском убедитесь, что HTML содержит элемент `#root`, иначе React выдаст ошибку 130.
- Если ошибка сохраняется, проверьте наличие свойства `icon` у пунктов меню Sidebar.

Перед созданием PR проверяйте успешное развёртывание на https://railway.com.
- Для работы используйте новый CLI: `npm install -g @railway/cli` и команду `railway status`.
- При ошибке `connect ENETUNREACH` задайте переменные `HTTP_PROXY` и `HTTPS_PROXY` или скачайте архив CLI с GitHub Releases, затем выполните `railway status`.
- Перед релизом создавайте тег `vX.Y.Z` и проверяйте успешное выполнение workflow `release.yml`.
- Для проверки кода используется дополнительный workflow `ci.yml` с MongoDB.
- В нём зависимости бэкенда устанавливаются через `npm ci --prefix bot`.
## Поддержка зависимостей
- Регулярно выполняйте `npm --prefix bot audit` и проверяйте вывод `npm --prefix bot outdated`.
- При обнаружении уязвимостей применяйте `npm --prefix bot audit fix --force` и
  снова проверяйте `npm --prefix bot outdated`.
- Для автоматизации есть скрипт `scripts/audit_dependencies.sh`.
- Зависимости сервера устанавливайте командой `npm ci --prefix bot`. Если `package-lock.json` отсутствует, сначала выполните `npm --prefix bot install`.
- Все обращения к MongoDB должны идти через модуль `bot/src/db/queries.js`.
- Соединение с базой выполняет `bot/src/db/connection.js`, модели используют его.
- Устаревшие опции `useNewUrlParser` и `useUnifiedTopology` удалены, чтобы
  избежать предупреждений драйвера.
- Для получения одной задачи добавлен маршрут `GET /api/tasks/:id`.

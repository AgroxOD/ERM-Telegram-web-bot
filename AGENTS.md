<!-- Назначение файла: правила использования Codex. -->

# Инструкции для Codex

## Стиль

- Все комментарии и документацию пишите на русском языке.
- При общении с пользователями отвечайте исключительно на русском.
- Код должен быть лаконичным и эффективным, избегайте избыточности.
- В начале каждого файла размещайте краткое описание его назначения и основных модулей.
- В комментариях описывайте назначение всех модулей и функций.
- При необходимости ищите в интернете актуальные лучшие решения.

## Тесты

Проект включает автотесты на Jest. Перед коммитом запускайте `npm test --prefix bot` и убеждайтесь, что все проверки проходят. Дополнительно выполняйте `npx eslint bot/src` для проверки кода. Если появляется сообщение `Cannot find module '@eslint/js'`, выполните `npm --prefix bot install`.
Также проверяйте фронтенд: `npm run lint --prefix bot/web`.

## Проверка Docker Compose

Если присутствует `docker-compose.yml`, перед коммитом можно выполнить:

```bash
docker compose config
```

Эта команда проверит корректность файла.
Перед запуском убедитесь, что создан `.env`, иначе появится ошибка о его отсутствии.
При необходимости сформируйте `.env` из экспортированных переменных скриптом
`./scripts/create_env_from_exports.sh`. Скрипт создаёт файл только если его нет,
используя значения из текущего окружения либо данные из `.env.example`.
Всегда запускайте этот скрипт при отсутствии `.env`.

- Все переменные окружения используются через модуль `bot/src/config.js`.

## Деплой

Перед развёртыванием убедитесь, что статический фронтенд собран командой
`npm --prefix bot run build-client` или через `Procfile`.

- Фронтенд теперь расположен в каталоге `bot/web`, Dockerfile и скрипты используют его вместо устаревшего `bot/client`.
- Перед сборкой установите зависимости фронтенда: `npm --prefix bot/web install`
- Если в логах появляется `GET /dashboard/` со статусом `404`, пересоберите фронтенд `npm --prefix bot run build-client` и убедитесь в наличии fallback `app.get('/{*splat}')` в API.
- Для fallback добавлен rate limiter, чтобы исключить перегрузку сервера.
- Маршрут `/api/tasks/:id` тоже ограничен rate limiter (100 запросов за 15 минут).
- Путь `/api/auth/login` принимает не более 5 запросов в минуту.
- Аналогичный лимит введён для `/api/groups`, `/api/users`, `/api/roles`, `/api/logs`
  и `/api/tasks/:id/status`.
- При пустой директории `bot/public` сервер сам выполнит `npm run build-client`, однако после обновлений фронтенда сборку лучше запускать вручную.
- После обновления зависимостей повторяйте `npm --prefix bot/web install` и затем `npm --prefix bot run build-client`.
- Для сборки Tailwind используйте плагин `@tailwindcss/postcss` в файле `postcss.config.js`.
- Конфигурация Tailwind должна соответствовать шаблону TailAdmin 1.3 и содержать шрифты Inter, Poppins и Roboto.
- Для форматирования кода фронтенда запустите `npm --prefix bot/web run format`.
  - Для поиска ошибок сохраняйте вывод в лог:
  ```bash
  npm --prefix bot/web install > /tmp/npm_install.log 2>&1 && tail -n 20 /tmp/npm_install.log
  npm --prefix bot run build-client > /tmp/npm_build.log 2>&1 && tail -n 20 /tmp/npm_build.log
  # или используйте ./scripts/build_client.sh
  ```
  Перед запуском `docker compose build` убедитесь, что запущен Docker daemon,
  иначе появится сообщение `Cannot connect to the Docker daemon`.

## Документация

- При добавлении функционала обновляйте раздел «В разработке» в `ROADMAP.md`.
- При любом изменении синхронно обновляйте `README.md`, `CHANGELOG.md`, `ROADMAP.md` и `AGENTS.md`.
- Создавайте задачи через шаблоны в `.github/ISSUE_TEMPLATE` и придерживайтесь `CONTRIBUTING.md`.
- Добавлен шаблон `task.yml` с полями локации, срока, статуса и ответственных.
- Поддерживайте раздел «Обзор текущего состояния» в `README.md`, фиксируя основные плюсы и недостатки проекта.
- В README добавлена секция «Лучшие практики CI/CD», обновляйте её по мере развития.
- При добавлении маршрутов используйте `helmet`, `cors` и валидацию через `express-validator`.
- `/auth/register` и `/auth/login` проверяют входные данные через `express-validator`.
- Страница `/dashboard/tasks` должна получать данные из MongoDB через API.
- Для неё создан компонент `TasksPage` с чеклистом и таймтрекером, API находится по пути `/api/tasks`.
- На этой странице должна быть форма создания новой задачи.
- При успешном создании задачи добавляйте уведомление через контекст `Toast`, который использует `NotificationBar`.
- Уведомление содержит иконку, кнопку закрытия и исчезает через три секунды.
- Используйте файл `docs/telegram_bot_manual.md` как руководство по настройке команд и вебхуков Telegram-бота.
- Для быстрого обновления меню можно запустить `scripts/set_bot_commands.sh`, файл `scripts/bot_commands.json` содержит пример команд.
- Для расширенных вызовов Telegram применяйте модуль `bot/src/services/telegramApi.js`.
- Бот регистрирует пользователей через `/start` и поддерживает команды `/list_users` и `/add_user` для админов.
- При создании пользователя бот формирует email как `<telegram_id>@telegram.local`,
  что позволяет избежать ошибки дублирования в MongoDB.
- Для компонентов страницы `tasks` используйте путь `../../_components/Section/*`.
- Новые разделы интерфейса: "Проекты", "Отчёты", "Админ" и "Профиль".
- Добавлена страница "Канбан" по пути `/tasks/kanban` для управления задачами.
- Для drag&drop используется `@hello-pangea/dnd`, совместимая с React 19.
- Страница `/tasks` оформлена в стиле TailAdmin `task-list` с фильтрами по статусу и модальным созданием задач.
- Кнопка создания называется «Новая задача». Старт и финал выбираются через кнопку «Карта», открывающую мини‑Google Maps. Скопированная ссылка «Поделиться» превращается в короткий адрес и сохраняется вместе с задачей. Форма также предлагает выбор типа и возможность тегать пользователей через `@id`.
- Форма пополнилась полями приоритета, автора, списка исполнителей и комментария с поддержкой упоминаний групп и ролей.
- Для проверки ссылок используется утилита `validateURL` на базе пакета `validator`.
- По клику на название задачи открывается модальное окно с полным описанием и возможностью редактирования.
- Мини‑карта загружается через `maps/embed`, поэтому Google не запрещает фрейм. В API разрешён `frame-src` для `https://www.google.com`.

- Для входа и регистрации добавлены страницы `/login` и `/register`; профиль загружается с `/profile`.
- Логика аутентификации реализована через `AuthContext` с методами `login` и `register`.
- После переноса фронтенда на React проверяйте работоспособность `/dashboard`.
- Компоненты Sidebar, Header и DashboardPage берём из шаблона TailAdmin и поддерживаем в каталоге `bot/web`.
- При доработке интерфейса ориентируйтесь на демо https://react-demo.tailadmin.com.
- Для актуализации стилей используйте архив `free-react-tailwind-admin-dashboard-main.zip` в корне.
- На странице `/dashboard` показывайте актуальные метрики задач, график активности и таблицу последних задач.
- Для примера верстки Dashboard смотрите `docs/dashboard_tailadmin.md`.
- На страницах `Админ`, `Проекты` и `Отчёты` должны присутствовать формы работы с пользователями,
- Инструкции по копированию дизайна TailAdmin в Figma описаны в `docs/tailadmin_figma_design.md`.
  Сам Figma-файл `TailAdminDesign.fig` размещён в каталоге `docs`.
  Файл в репозитории является заглушкой; полный дизайн хранится во внешнем хранилище.
  группами и фильтрами отчётов. Формы отправляют запросы на `/api/users`, `/api/groups`
  и `/api/tasks/report/summary` соответственно.
- Сервер принимает запросы на `/api/groups`, `/api/users`, `/api/roles` и `/api/logs`. Статус задач меняется через `/api/tasks/:id/status`.
- Страницы `Роли` и `Логи` добавлены для управления ролями и просмотра последних записей.
  На странице `Роли` используется форма создания новой роли с запросом на `/api/roles`.
- Дополнительно внедрены компоненты TailAdmin: Dropdown меню профиля, вкладки в разделе профиля и пагинация списка задач.
- На Dashboard, странице профиля и в отчётах отображаются breadcrumbs.
- В Header добавлено выпадающее меню уведомлений.
- Перед запуском убедитесь, что HTML содержит элемент `#root`, иначе React выдаст ошибку 130.
- Если ошибка сохраняется, проверьте наличие свойства `icon` у пунктов меню Sidebar.

Перед созданием PR проверяйте успешное развёртывание на https://railway.com.

- Для работы используйте новый CLI: `npm install -g @railway/cli` и команду `railway status`.
- При ошибке `connect ENETUNREACH` задайте переменные `HTTP_PROXY` и `HTTPS_PROXY` или скачайте архив CLI с GitHub Releases, затем выполните `railway status`.
- Перед релизом создавайте тег `vX.Y.Z` и проверяйте успешное выполнение workflow `release.yml`.
- Для проверки кода используется дополнительный workflow `ci.yml` с MongoDB.
- В нём зависимости бэкенда устанавливаются через `npm ci --prefix bot`. После установки запускайте `npm audit fix --prefix bot`.

## Поддержка зависимостей

- Регулярно выполняйте `npm --prefix bot audit` и проверяйте вывод `npm --prefix bot outdated`.
- После установки зависимостей запускайте `npm audit fix --prefix bot` для автоматического устранения найденных уязвимостей и снова проверяйте `npm --prefix bot outdated`.
- Для автоматизации есть скрипт `scripts/audit_dependencies.sh`.
- В качестве примера обновляйте ключевые пакеты, сейчас актуальны `@aws-sdk/client-s3`, `jest` и `@tailwindcss/postcss` версии 4.1.11.
- При появлении предупреждений npm о `lodash.isequal`, `lodash.get`, `inflight` и `glob` обновляйте зависимости до свежих версий.
- Для устранения устаревшего `inflight` проект использует override `glob@11` в `bot/package.json`.
- Зависимости сервера устанавливайте командой `npm ci --prefix bot || npm --prefix bot install`, затем `npm audit fix --prefix bot`.
- Все обращения к MongoDB должны идти через модуль `bot/src/db/queries.js`.
- Для установки используйте скрипт `scripts/install_bot_deps.sh`, который выполняет `npm ci` и затем `npm audit fix`.
- Соединение с базой выполняет `bot/src/db/connection.js`, модели используют его.
- Устаревшие опции `useNewUrlParser` и `useUnifiedTopology` удалены, чтобы
  избежать предупреждений драйвера.
- Для получения одной задачи добавлен маршрут `GET /api/tasks/:id`.
- Добавлена CLI `crystallizationManager.ts` для оценки зрелости задач, команды описаны в README.
- Сценарий `crystal:loop` запускает лупы кристаллизации для всего репозитория и повторяется, пока средний уровень не превысит 99%.
- При ошибке `ERR_UNKNOWN_FILE_EXTENSION` выполните `npm run crystal:auto-update`.
- Для обновления бейджа кристаллизации используйте `npm run crystal:update-badge`.
- При работе с IDE синхронизируйте файл `crystallization.json` командой `npm run crystal:sync`.
- Команда `crystal:auto-update` опрашивает `https://api.github.com/repos/AgroxOD/crystallization-development/commits`
  и при обнаружении нового коммита обновляет `crystallizationManager.ts`.
- Перед коммитом проверяйте код командами `npm test --prefix bot`,
  `npx eslint bot/src` и `npm run lint --prefix bot/web`.
- В случае ошибки авторизации мини‑приложение удаляет токен из `localStorage`,
  чтобы исключить повторные 401 при загрузке страниц.
- На странице `/tasks` при ответе 401 или 403 пользователь сразу перенаправляется на `/login`.
- Для корректной работы SPA убраны маршруты `/tasks`; все обращения идут через `/api/tasks`.
- Храним отчёты Lighthouse в каталоге `docs`, примеры: `lighthouse_20250624.md` и `lighthouse_20250626.md`.
- Интерфейс страницы `/roles` стилизован под TailAdmin: форма создания роли и список ролей размещены в карточках с белым фоном и скруглёнными границами.
- Страница `/tasks` получила оформление TailAdmin, таблица и форма теперь используют общие классы и цвета.
- В таблицу задач добавлена кнопка удаления, на сервере реализован `DELETE /api/tasks/:id`.
- Формы проектов и пользователей обновлены по тому же стилю, в `index.css` добавлены утилиты `.btn`, `.btn-blue`, `.btn-gray` и `.btn-green`.
- Исправлены ссылки на workflow Docker и Release в README.
- Подготовлено подробное руководство по TailAdmin: docs/extended_tailadmin_guide.md.
- График `TasksChart` оформлен в корпоративных цветах и реагирует на тёмную тему.
- На Dashboard при загрузке отображаются skeleton-карточки и таблица-заглушка.
- Реализован контекст ToastProvider для отображения нескольких NotificationBar.
- Страницы входа и регистрации приведены к стилю TailAdmin, модальные окна задач плавно появляются.
- Добавлены Breadcrumbs и стили TailAdmin на страницах "Админ", "Проекты" и "Логи".
- Для проверки API и БД создан скрипт `scripts/check_db_fetch.cjs`.
- Запросы к задачам вынесены в модуль `bot/web/src/services/tasks.js`.
- В канбане и форме создания теперь используются статусы `new`, `in-progress` и `done`.
- Скрипт `migrate.js` удаляет устаревший индекс `email_1`, регистрация бота не падает при повторном `/register`.
- Полная копия дизайна TailAdmin создана в Figma, инструкция и файл расположены в docs/tailadmin_figma_design.md и docs/TailAdminDesign.fig.
- Обновляйте `bot/web/package-lock.json` после добавления зависимостей, иначе `npm ci` в Dockerfile завершится ошибкой.
- Для всех fetch-запросов используется helper authFetch, который перенаправляет на /login при отсутствии токена.
- Если при сборке Vite появляется предупреждение о размере чанков, внедрите `React.lazy` и настройте `manualChunks` в `vite.config.js`.
- При появлении сообщений `Unexpected ")"` от esbuild проверьте стили. Удалите нестандартные директивы вроде `@custom-variant dark`.
- Обновляйте ключевые пакеты при появлении сообщений об устаревших зависимостях.
- Проверьте цвета текста в тёмной теме: события календаря должны оставаться читаемыми.
  Например, `@aws-sdk/client-s3` повышен до версии 3.837.0, а во фронтенде
  обновлены `@vitejs/plugin-react`, `prettier`, `react-router-dom` и `vite`.
- Переключатель темы использует настройку `prefers-color-scheme` при отсутствии сохранённого значения.
- В файле `bot/web/index.html` перед загрузкой приложения установлен скрипт, который добавляет класс `dark` на элемент `<html>`, если сохранена тёмная тема или она выбрана в системе.



<!-- Назначение файла: список основных изменений. -->

# История изменений

## [Новый]
- Добавлена секция о меню без `/` в `telegram_bot_manual.md`.
- Сообщения бота переведены на русский язык.
- Главное меню использует текстовые кнопки без слешей и `bot.hears`.

- Проект объединяет код бота и клиента в каталоге `bot`.
- Для запуска используется Docker Compose и переменный файл `.env`.
- README, ROADMAP и AGENTS упрощены и содержат только важные инструкции.
- Все тесты выполняются через Jest и ESLint.
- По умолчанию `.env.example` использует локальную MongoDB на 27017.
- В документацию добавлено требование MongoDB-хоста для GitHub Actions или запуск Railway CLI.
- Файл `.env` удалён из репозитория; создавайте его локально из `.env.example`.
- В README добавлена секция о проверке подключения к MongoDB скриптом `check_mongo.cjs`.
- В README описан запуск `npm --prefix bot run check:mongo` для проверки MongoDB.
- В ROADMAP уточнена задача по созданию инструкции проверки базы.
- Добавлен скрипт `setup_and_test.sh` для автоматической установки зависимостей и запуска тестов.
- Workflow CI теперь использует этот скрипт для подготовки окружения перед тестами.
- В `check_mongo.cjs` реализована повторная попытка подключения с `authSource=admin` при ошибке аутентификации.
- Docker Compose теперь поднимает MongoDB с логином `admin` и паролем `admin`;
- Модуль `taskFields.cjs` содержит описание формы задачи для всех клиентов
  `.env.example` обновлён соответствующим URL.
- Форма создания задачи объединена в компонент `TaskForm`, который используется
  в веб‑клиенте и мини‑приложении Telegram.
- В README пояснена переменная `BOT_API_URL` и приведён пример запуска
  локального telegram-bot-api.
- Скрипт `create_env_from_exports.sh` теперь экранирует значения переменных, что позволяет использовать специальные символы.
- Добавлен краткий абзац о назначении `BOT_API_URL` и локальном сервере telegram-bot-api.
  - В `docker-compose.yml` для MongoDB прописан `healthcheck`, чтобы бот запускался только после готовности базы.
  - В `healthcheck` добавлены логин и пароль `admin`/`admin`.
- Удалены устаревшие отчёты Lighthouse, сокращён файл `extended_tailadmin_guide.md`.
- Workflow `docker.yml` запускает локальный контейнер MongoDB для проверки
  соединения скриптом `check_mongo.cjs`.
- В `healthcheck` теперь используется `mongosh` вместо `mongo` для совместимости с новой версией образа MongoDB.
- Добавлен скрипт `create_admin_user.js` для создания администратора по Telegram ID.
- Исправлена функция `verifyAdmin`, ошибки теперь приводят к возврату `false`.
- Добавлен тест `verifyToken.test.js`, проверяющий отказ без JWT.
- Скрипт `create_admin_user.js` переписан на CommonJS с обработкой ошибок подключения и поиском `mongoose` в каталоге `bot` при необходимости.
- README теперь указывает запуск `npm ci --prefix bot` перед выполнением `create_admin_user.js` и демонстрирует пример `NODE_PATH=./bot/node_modules node scripts/create_admin_user.js <id> [username]`.
- Удалена авторизация через Telegram Login, вместо неё используется код подтверждения.
- Метод `verifyUser` исключён, добавлен сервис `otp` и страница `CodeLogin`.
- Документация уточняет, что мини‑приложение доступно только участникам группы `CHAT_ID`.
- Добавлена страница логина с возможностью входа по `username` и кнопкой открытия @userinfobot. Сайдбар и шапка скрыты до авторизации.
- Удалена возможность входа по `username`; страница логина принимает только Telegram ID и код.
- Исправлена ошибка "listDepartments is not a function".
- Запуск серверов переведён на `pm2` для мониторинга и автоматического перезапуска.
- Обновлён `pm2` до версии 6.0.8 для устранения уязвимостей.
- Сообщения о запуске API и бота выводятся на русском языке.
- Исправлен маршрут `/tasks/mentioned`, который перекрывался путём `/:id` и вызывал ошибку приведения ObjectId.
- MongoDB перезапускается Docker Compose при сбое, подключение выполняется с несколькими попытками. Удалены неиспользуемые скрипты.
- Обработчик ошибок API теперь корректно отвечает на прерванные HTTP-запросы

- Удалена устаревшая функция telegramLogin и связанные проверки.
- Добавлены глобальные обработчики ошибок для перезапуска сервисов.
- Файл ecosystem.config.cjs задаёт max_restarts и min_uptime.
- Конфигурация pm2 дополнена параметром restart_delay для надёжного перезапуска.
- Добавлен тест scheduler.test.js.
- Исправлен запуск `pm2-runtime` в Dockerfile и Procfile.
- Добавлен тест `errorHandler.test.js`.
- Удалена зависимость TDWeb и страница `/chats` с соответствующим пунктом меню.
- Удалён неиспользуемый `reportController` и тест `report.test.js`.
- Проверка JWT теперь принимает только алгоритм `HS256`.
- Код подтверждения можно ввести не более пяти раз, имена загружаемых файлов очищаются от пути.
- Сообщения о старте сервисов выводят окружение и версию Node.
- Добавлена команда `/whoami` и сервис `userInfoService`.
- При сбое установки вебхука бот автоматически запускается в режиме polling.
- После переключения на polling администратору отправляется сообщение с ошибкой.
- Появился скрипт `check_bot_token.sh` для проверки токена перед деплоем.
- Команды в `bot_commands.json` и `bot_messages.json` приведены к единому списку.
- В мануале уточнён скрипт `set_attachment_menu_url.js` для обновления меню.
- В `startBot` функция `bot.launch()` обёрнута в try/catch, при ошибке выводится подробное сообщение и процесс завершается.
- Procfile теперь запускает `scripts/set_bot_commands.sh`, чтобы автоматически
  синхронизировать команды меню при распаковке на Railway.
- Бот теперь всегда работает в режиме polling, переменная `WEBHOOK_URL` удалена.
- При проверке кода подтверждения дополнительно проверяется статус участника через `getChatMember`.
- Главное меню Telegram теперь содержит только команду `/start`, которая открывает список других действий.
- Добавлена команда `/register` для отдельной регистрации участников группы.
- Ссылки на мини‑приложение отправляются только в личные сообщения.
- В профиле пользователя можно изменить ФИО и телефон.


- Исправлен путь к модулю `taskFields.cjs` в `TaskForm`.

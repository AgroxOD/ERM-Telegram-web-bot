<!-- Назначение файла: список основных изменений. -->

# История изменений

## [Новый]
- Переработан расчёт маршрутов: используется сервис `ORSM` вместо GraphHopper и erm-map
- Уточнён владелец репозитория и email в SECURITY.md и CODEOWNERS
- В `setup_and_test.sh` тесты запускаются с флагом `--detectOpenHandles`
- Скрипт `setup_and_test.sh` проверяет `docker compose config` только при наличии команды `docker` и выводит предупреждение, если Docker не найден
- Добавлен скрипт `audit_deps.sh` и шаг CI для проверки зависимостей
- Фильтр `status` в `/api/v1/routes/all` защищён от инъекций
- Leaflet подключается локально, политика CSP разрешает тайлы OpenStreetMap
- Политика CSP разрешает подключение к сервису ORSM
  и `router.project-osrm.org`
- Пустые фильтры `/api/v1/routes/all` не отправляются
 - Страница «Маршруты» строит путь через OSRM,
   порядок отображения зависит от сортировки задач
 - Карта занимает верхнюю часть страницы, таблица закреплена снизу
- Старт и финиш маршрута отмечены интерактивными иконками
- Фильтры статуса и отдела убраны, задачи показаны таблицей с сортировкой,
  администратор может открыть их на редактирование
- Форма задачи фиксирована поверх карты, окно можно свернуть или развернуть,
  администратор может удалить задачу после подтверждения

- На форме входа можно отправить данные клавишей Enter
- Поле "Название" перемещено в начало формы задачи
- Справочники задач загружаются одним запросом для предотвращения ошибки 429
- Таблица ответов бота в `docs/bot_responses.md` полностью на русском
- В примерах `.env` и документации `ROUTING_URL` указывает на `https://orsm-production.up.railway.app/route`
- Добавлена переменная `VITE_ROUTING_URL` для веб-клиента
- Добавлена `docs/orsm.md` с инструкцией по запуску сервиса ORSM
- README обновлён ссылкой на документ `docs/orsm.md`
- Dockerfile корректно копирует каталог `bot`, сборка образа проходит без ошибок
- Добавлен `docs/railway_full_setup.md` с описанием полного развёртывания на Railway
- Клиент переведён на React 18 ради совместимости с TelegramUI
- Поддержан запуск в браузере через флаг `?browser=1`, telegram-apps-sdk не загружается
- Кнопка «Браузер» ведёт на `https://agromarket.up.railway.app/?browser=1`
- Клиент автоматически выбирает режим браузера при отсутствии `Telegram.WebApp`
- Завершение таймеров в `messageQueue` устранено
- Исправлен запрос обновления отдела: используется `$set`
- Добавлен тест `departments.test.js` для сохранения имени отдела
- Код бота и клиента объединён в каталоге `bot`
- Приоритет по умолчанию исправлен на форму «В течение дня»
- Добавлены скрипты `setup_and_test.sh`, `create_env_from_exports.sh`, `create_admin_user.js` и `check_bot_token.sh`
- MongoDB запускается с учётными данными `admin`/`admin` и healthcheck на `mongosh`
- Бот работает через polling, меню и сообщения синхронизируются скриптами
- Авторизация через одноразовый код; количество попыток ограничено
- Формы задач вынесены в общий модуль `taskFields.cjs`
- Добавлены глобальные обработчики ошибок и дополнительные тесты
- Команда `/whoami` показывает ID и статус пользователя
- Добавлена пагинация списка задач через параметры `page` и `limit`
- В модели задач появилось поле `slug`, генерируемое из названия
- Добавлены `robots.txt`, мета‑описание и aria‑метки для кнопок
- Модель задач расширена логистикой, закупками и работами
- Добавлены поля `transport_type`, `payment_method`, `priority`, `status`
- Веб-клиент получил редактор React Quill и поддержку TelegramUI
  через библиотеку @telegram-apps/sdk-react
- CRUD-маршруты `/api/v1/tasks` поддерживают полный набор полей
- Форма задач и контроллеры поддерживают поля `transport_type`,
  `payment_method` и выбор статуса
- Добавлены коллекции `DefaultValue` и `Transport` для справочников
- API `/api/v1/defaults/:name` и `/api/v1/transports` позволяет редактировать значения
- Для этих маршрутов добавлен rate limit и проверка входных данных
- Формы задач открываются поверх текущей страницы через параметры URL
- Сайдбар можно полностью скрыть и раскрыть
- При скрытом сайдбаре шапка растягивается, форма задач центрируется и занимает оставшееся пространство
- Макет формы адаптирован под мобильные устройства
- Добавлена возможность редактировать отделы через `/api/v1/departments` и страницу `/defaults`
- Улучшена безопасность обновления отделов: имя проходит проверку типа
- Интерфейс задач дополнен новой формой
- pm2 переведён в fork-режим, чтобы исключить конфликт polling
- Добавлены новые значения enum: "Построить", "Починить" для `task_type` и "Без оплаты" для `payment_method`
- Уточнён список допустимых `task_type` в документации
- Добавлена единая форма для создания и редактирования задач
- Название задачи теперь включает идентификатор вида `ERM_000001`
- API переведён на префикс `/api/v1`
- Изменён путь подключения к MongoDB на `ermdb`
- В формах задач отображается `request_id` и дата создания
- Поле "Ответственный" исключено, "Контролёр" поддерживает выбор нескольких
- Поля формы расположены в порядке: дата начала, срок выполнения, статус, приоритет, отдел и далее
- Кнопки "Карта" ведут на ссылку <https://maps.app.goo.gl/xsiC9fHdunCcifQF6> без iframe
- "Исполнител(и)ь" и "Контролёр" можно выбирать из списка по кнопке «+»
- Бот разворачивает короткие ссылки Google Maps и показывает координаты
- Форма задач также разворачивает короткие ссылки Google Maps
- В форме задачи при вставке ссылки поле скрывается, отображается адрес
- Добавлены поля `startCoordinates` и `finishCoordinates`
- Координаты точки теперь выводятся под ссылкой в форме
- Отправка null координат исключена, поля передаются только при наличии
- Появился эндпойнт `/api/v1/route` для расчёта расстояния
- В модель задач добавлено поле `route_distance_km`
- Добавлено поле `google_route_url` и автоматическая генерация ссылки маршрута
- Добавлен эндпойнт `/api/v1/routes/all` и страница «Маршруты»
- В форме появилось поле `start_date` для даты начала
- Автоподстановка финальной точки из стартовой отключена
- Выпадающие списки упоминаний удалены
- Скрипт `scripts/db/seed.js` создаёт задачу с приоритетом «Срочно»
- В списке задач доступны даты начала и дедлайн,
  администратор может менять статус и приоритет, добавлена сортировка
- После создания задачи список на странице `/tasks` обновляется автоматически,
  появилась кнопка «Обновить задачи»
- README дополнен примером JSON со `startCoordinates` и `finishCoordinates`
- В `docs/telegram_bot_manual.md` описано разворачивание коротких ссылок Google Maps

### Безопасность
- Сообщение о загрузке `BOT_TOKEN` не раскрывает даже начало значения


- Исправлены пути API в клиенте: добавлен префикс /api/v1
- Удалены неиспользуемые состояния `roles` и `groups` в компоненте `TaskDialog`
- Провайдер `ThemeProvider` корректно экспортируется из файла `ThemeContext.tsx`
- Провайдеры `SidebarProvider` и `ToastProvider` экспортируются из файлов контекста
- Исправлены зависимости `useEffect` в `TaskDialog`, предупреждения ESLint исчезли

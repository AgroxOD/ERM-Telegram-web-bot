<!-- Назначение файла: список основных изменений. -->

# История изменений

## [Новый]

- Проект объединяет код бота и клиента в каталоге `bot`.
- Для запуска используется Docker Compose и переменный файл `.env`.
- README, ROADMAP и AGENTS упрощены и содержат только важные инструкции.
- Все тесты выполняются через Jest и ESLint.
- По умолчанию `.env.example` использует локальную MongoDB на 27017.
- В документацию добавлено требование MongoDB-хоста для GitHub Actions или запуск Railway CLI.
- Файл `.env` удалён из репозитория; создавайте его локально из `.env.example`.
- В README добавлена секция о проверке подключения к MongoDB скриптом `check_mongo.cjs`.
- В README описан запуск `npm --prefix bot run check:mongo` для проверки MongoDB.
- В ROADMAP уточнена задача по созданию инструкции проверки базы.
- Добавлен скрипт `setup_and_test.sh` для автоматической установки зависимостей и запуска тестов.
- Workflow CI теперь использует этот скрипт для подготовки окружения перед тестами.
- В `check_mongo.cjs` реализована повторная попытка подключения с `authSource=admin` при ошибке аутентификации.
- Docker Compose теперь поднимает MongoDB с логином `admin` и паролем `admin`;
  `.env.example` обновлён соответствующим URL.
- В README пояснена переменная `BOT_API_URL` и приведён пример запуска
  локального telegram-bot-api.
- Добавлен раздел о подготовке TDWeb перед сборкой клиента и пример запуска
  `scripts/setup_tdweb.sh`.
- Скрипт `create_env_from_exports.sh` теперь экранирует значения переменных, что позволяет использовать специальные символы.
- Добавлен краткий абзац о назначении `BOT_API_URL` и локальном сервере telegram-bot-api.
  - В `docker-compose.yml` для MongoDB прописан `healthcheck`, чтобы бот запускался только после готовности базы.
  - В `healthcheck` добавлены логин и пароль `admin`/`admin`.
- Удалены устаревшие отчёты Lighthouse, сокращён файл `extended_tailadmin_guide.md`.
- Workflow `docker.yml` запускает локальный контейнер MongoDB для проверки
  соединения скриптом `check_mongo.cjs`.
- В `healthcheck` теперь используется `mongosh` вместо `mongo` для совместимости с новой версией образа MongoDB.
- Добавлен скрипт `create_admin_user.js` для создания администратора по Telegram ID.
- Исправлена функция `verifyAdmin`, ошибки теперь приводят к возврату `false`.
- Добавлен тест `verifyToken.test.js`, проверяющий отказ без JWT.
- Скрипт `create_admin_user.js` переписан на CommonJS с обработкой ошибок подключения и поиском `mongoose` в каталоге `bot` при необходимости.
- README теперь указывает запуск `npm ci --prefix bot` перед выполнением `create_admin_user.js` и демонстрирует пример `NODE_PATH=./bot/node_modules node scripts/create_admin_user.js <id> [username]`.
- Удалена авторизация через Telegram Login, вместо неё используется код подтверждения.
- Метод `verifyUser` исключён, добавлен сервис `otp` и страница `CodeLogin`.
- Документация уточняет, что мини‑приложение доступно только участникам группы `CHAT_ID`.
- Добавлена страница логина с возможностью входа по `username` и кнопкой открытия @userinfobot. Сайдбар и шапка скрыты до авторизации.
- Удалена возможность входа по `username`; страница логина принимает только Telegram ID и код.
- Исправлена ошибка "listDepartments is not a function".
- Запуск серверов переведён на `pm2` для мониторинга и автоматического перезапуска.
- Обновлён `pm2` до версии 6.0.8 для устранения уязвимостей.
- Сообщения о запуске API и бота выводятся на русском языке.
- Исправлен маршрут `/tasks/mentioned`, который перекрывался путём `/:id` и вызывал ошибку приведения ObjectId.
- MongoDB перезапускается Docker Compose при сбое, подключение выполняется с несколькими попытками. Удалены неиспользуемые скрипты.
- Обработчик ошибок API теперь корректно отвечает на прерванные HTTP-запросы

- Удалена устаревшая функция telegramLogin и связанные проверки.
- Добавлены глобальные обработчики ошибок для перезапуска сервисов.
- Файл ecosystem.config.cjs задаёт max_restarts и min_uptime.
- Добавлен тест scheduler.test.js.
- Исправлен запуск `pm2-runtime` в Dockerfile и Procfile.
- Добавлен тест `errorHandler.test.js`.


<!-- Назначение файла: список изменений по версиям. -->

# История изменений

Все значимые изменения будут фиксироваться в этом файле.

## [Новый]

- Поддержаны глубокие ссылки `/start`: `task_<id>` сразу открывает задачу, `invite_<departmentId>` добавляет пользователя в отдел.
- В начало ключевых файлов добавлены строки с назначением: `docs/dashboard_tailadmin.md`, `docs/lighthouse_20250624.md`, `docs/lighthouse_20250626.md`, `bot/web/README.md`.

- Ссылка на мини‑приложение заменена на кнопку «Открыть приложение»,
  ссылка генерируется только для зарегистрированных пользователей.
- При ошибке `BUTTON_TYPE_INVALID` бот отправляет обычную
  URL‑кнопку вместо Web App.
- При наличии `WEBHOOK_URL` бот регистрирует вебхук и работает через него.
- Добавлена команда `/browser` для получения ссылки на приложение и открытия его во внешнем браузере.
- Добавлена команда `/help` с кратким описанием всех команд.
- Мини‑приложение отправляет `sendData('task_created:<id>')`, бот
  обрабатывает `web_app_data` и подтверждает создание задачи.
- Списки задач в командах `/list_tasks` и `/list_all_tasks` оснащены inline-кнопками для отметки выполнения и удаления.
- Из репозитория удалён архив free-react-tailwind-admin-dashboard-main.zip; ссылка на источник добавлена в README.
- Пользователи бота теперь хранятся в коллекции `telegram_users`, что
  устранило ошибку `E11000` при регистрации через команду `/register`.
- В эту коллекцию добавлено поле `receive_reminders`, позволяющее отключать личные уведомления от планировщика.
- Добавлена проверка `MONGO_DATABASE_URL` в `bot/src/config.js`,
  при неверной схеме выводится понятное сообщение.
- Теперь `bot/src/config.js` ищет `.env` в корне и проверяет `APP_URL` на HTTPS,
  что устранило ошибку Bad Request при открытии приложения.
- В README раздела «Установка» теперь напоминает запуск `scripts/create_env_from_exports.sh`.
- Добавлено пояснение о проверке схем `APP_URL` и `MONGO_DATABASE_URL` в `bot/src/config.js`.
- Файл `.env.example` обновлён: присутствуют все переменные из конфигурации.
- Виджет Telegram Login обновлён до версии 22 и запрашивает доступ `write`.
- При запуске тестов переменная `APP_URL` должна быть задана, иначе Jest
  завершится ошибкой.
- Добавлен планировщик `scheduler.js`, который каждую минуту проверяет задачи с `remind_at` и отправляет напоминание.
- Планировщик напоминаний рассылает сообщения каждому пользователю из полей `assigned_user_id` и `assignees`, учитывая настройку «получать напоминания» в коллекции `telegram_users`. При отсутствии исполнителей уведомление приходит в чат отдела.
- Добавлен скрипт `scripts/get_menu_button_url.js` для получения URL кнопки меню.
- В документации показан пример его вывода при стандартных переменных окружения.
- Появился скрипт `scripts/set_menu_button_url.js` для установки URL кнопки меню.
- Команды `/assign_task`, `/upload_file` и `/edit_last` проверяют наличие обязательных параметров и сообщают об ошибке, если аргументы не переданы.
- `/assign_task` позволяет выбрать пользователя через `KeyboardButton.requestUser` или группу через `KeyboardButton.requestChat`.
- Добавлены тесты commandValidation.test.js, которые эмулируют вызовы этих команд без параметров.
- `/upload_file <taskId>` принимает документ или фото, загружает его в R2 и добавляет ссылку в задачу.
- Inline-режим распознаёт `add <текст>` и `search <ключ>`, создаёт задачи и ищет до десяти совпадений.
- Руководство `docs/telegram_bot_manual.md` дополнено пошаговой настройкой BotFather и командой `getMyCommands` для проверки меню.
- В этот документ добавлен раздел «Типовые ошибки API» с примером `Bad Request: message text is empty` и описанием ответа бота после валидации.
- Создан файл `bot/src/messages.js` с текстами ответов бота и скрипт `scripts/set_bot_messages.sh` для их установки через Bot API.
- Форма создания задачи получила поля приоритета, автора и списка исполнителей, поддерживает первый комментарий и упоминания групп и ролей.
- Команда `/create_task` использует текст сообщения как `title` и приоритет "В течении дня", что устранило ошибку валидации при деплое.
- При отсутствии текста бот уведомляет о необходимости передать название задачи.
- Добавлены breadcrumbs на Dashboard, странице профиля и в отчётах.
- В Header реализовано выпадающее меню уведомлений.
- При отсутствии токена в Header показывается ссылка «Войти», иначе меню профиля.
- Скрипт миграции удаляет устаревший индекс `email_1`,
  регистрация через `/register` больше не приводит к ошибке `E11000`.
- Исправлены статусы задач в канбане и форме создания: используется `new/in-progress/done`.
- Добавлены тесты `kanbanStatus.test.js` и `authRole.test.js`.
- Добавлен скрипт `scripts/check_db_fetch.cjs` для проверки работы API и БД.
- Обновлён список команд в `scripts/bot_commands.json`, меню Telegram
  обновляется скриптом `scripts/set_bot_commands.sh`.
- ESLint фронтенда использует `@typescript-eslint/parser` и плагин,
  маска файлов теперь `**/*.{js,jsx,ts,tsx}`.
- В примере `.env.example` переменная `MONGO_DATABASE_URL` указывает на кластер
  `arjs-db.4pzoyda.mongodb.net/agromarket`.
- Запросы к задачам вынесены в модуль `bot/web/src/services/tasks.js`.
- Компонент `Admin` написан на TypeScript и импортирует контекст авторизации как
  ES‑модуль.
- Внедрена ленивая загрузка страниц через `React.lazy`, что сократило итоговый размер бандла.
- Регистрация через веб отключена, доступ дают только участники Telegram‑группы.
- Добавлена страница `/login` с Telegram Login. Пользователь получает JWT и
  автоматически входит в приложение.
- CSP сервера разрешает `script-src https://telegram.org 'unsafe-eval'` и `media-src data:`, что устраняет ошибки Telegram Login.
- Добавлены отделы и фильтрация задач по отделу пользователя.
- Профиль показывает задачи, где пользователь упомянут.
- Исправлены предупреждения React Hooks на Dashboard и TasksPage.
- В отчётах KPI маршрут `/api/tasks/report/summary` принимает параметры `from` и `to`.
- Создан контроллер `reportController.js`, который передаёт параметры `from` и `to` в агрегат MongoDB.
- Обновлены зависимости `@aws-sdk/client-s3` и `jest`.
- Плагин `@tailwindcss/postcss` обновлён до версии 4.1.11 для корректной сборки CSS.
- Workflow `release.yml` теперь собирает Docker-образ и выполняет `railway up`.
- Исправлено неверное отображение текста событий календаря в тёмной теме.
- Исправлены цвета текста в выпадающих меню, хлебных крошках и вкладках для тёмной темы.
- Устранены npm-предупреждения о пакетах `lodash.isequal`, `lodash.get`, `inflight` и `glob`.
- Пакет `glob` принудительно обновлён до версии 11 через раздел `overrides`, что полностью убрало зависимость `inflight`.
- Подготовлено описание копии дизайна TailAdmin в Figma (docs/tailadmin_figma_design.md).
- Файл Figma `TailAdminDesign.fig` размещён в каталоге `docs`.
  Расширено руководство `docs/tailadmin_figma_design.md`, добавлены описания страниц и компонентов, макет включает обе темы.
- Добавлен сценарий `crystal:loop` для запуска лупов кристаллизации всего репозитория.
  Файл в репозитории является заглушкой; полноценный Figma-файл хранится во внешнем хранилище.
- Удалена директива `@custom-variant dark` в `bot/web/src/index.css`, что устранило предупреждения esbuild при минификации стилей.
- NotificationBar получил иконку и кнопку закрытия, TasksChart теперь стилизован цветами TailAdmin и учитывает выбранную тему.
- Удалены устаревшие маршруты `/tasks`; теперь используется только `/api/tasks`,
  что устранило ошибку `{"message":"No token provided"}` при обновлении страниц.
- Исправлена ошибка `MongoServerError: duplicate key` при регистрации через бота:
  пользователю присваивается email вида `<telegram_id>@telegram.local`.
- Реализован стек Toast‑уведомлений на базе NotificationBar.
- При ошибке `ERR_UNKNOWN_FILE_EXTENSION` рекомендуется выполнить `npm run crystal:auto-update`.
- Кнопка добавления задачи переименована в «Новая задача», форма содержит карту с выбором точек и поле типа задачи.
- Добавлена утилита `validateURL` на основе пакета `validator` для проверки ссылок Google Maps.
- Tailwind config синхронизирован с шаблоном TailAdmin 1.3, подключены шрифты Inter, Poppins и Roboto.
- Реализованы выпадающие меню профиля, вкладки, пагинация и skeleton‑лоадеры для полной адаптации под TailAdmin.
- На Dashboard реализована загрузка с skeleton‑карточками и ожиданием списка задач.
- Страницы входа и регистрации получили спиннеры и уведомления, модальные окна задач плавно появляются.
- На странице `Tasks` название задачи теперь открывает модальное окно с подробной формой, где можно редактировать локацию, срок и комментарии.
- Цикл продолжается, пока средний уровень не достигнет 99%.
- Добавлена система кристаллизации задач и CLI `crystallizationManager.ts`.
- Обновлён кристализатор до версии с поддержкой алмазного уровня и дополнительными командами.
- Унификация доступа к MongoDB через `bot/src/db/queries.js`.
- Подключение к базе вынесено в `bot/src/db/connection.js` с пулом соединений.
- Добавлена карта запросов `docs/db_request_map.md`.
- Добавлен workflow `release.yml` для автоматических GitHub Releases.
- В документацию добавлен файл `docs/dashboard_tailadmin.md` с примером верстки Dashboard.
- Создан шаблон Pull Request и файл CODEOWNERS.
- Добавлен шаблон issue `task.yml` для постановки задач.
- В README добавлена секция с лучшими практиками CI/CD.
- Уточнена инструкция сборки: после `npm ci --prefix bot` следует запускать `npm audit fix --prefix bot`.
- Исправлена ошибка линтера в компоненте Kanban: удалён неиспользуемый параметр.
- Добавлен скрипт `scripts/install_bot_deps.sh`, который выполняет `npm ci` и `npm audit fix`. Workflows обновлены для его использования.
- Добавлен скрипт `crystal:auto-update` для получения свежего кристализатора из
  репозитория `AgroxOD/crystallization-development` через GitHub API.
- Исправлены ссылки на workflow Docker и Release в README.
- Проведена автоматическая проверка: тесты и линтер проходят без ошибок.
- Маршруты `/groups`, `/users`, `/roles` и `/logs` перенесены под `/api`.
- Обновлён путь изменения статуса задач: `/api/tasks/:id/status`.
- Добавлена очистка `localStorage` при ошибке запроса профиля, чтобы предотвратить
  бесконечные ответы 401.
- Создание инфраструктуры проекта и документации.
- Перевод проекта на MongoDB и интеграцию с R2.
- Добавлены тесты модулей и инструкция по развёртыванию на Railway.
- Реализован маршрут `/health` для проверки статуса API.
- В `Procfile` добавлена сборка фронтенда для устранения ошибки `404` на `/dashboard`.
- Уточнена документация по устранению ошибки `404` на `/dashboard`.
- Интегрирован обновлённый Dashboard с KPI‑карточками, графиком и таблицей последних задач.
- Обновлена конфигурация PostCSS: используется плагин `@tailwindcss/postcss`.
- Страница `/tasks` оформлена в стиле TailAdmin `task-list` с фильтрами и модальным созданием задач.
- Добавлены рекомендации по установке зависимостей клиентского приложения при ошибке `next: not found`.
- Во фронтенд добавлены страницы `Roles` и `Logs`. На странице ролей появилась форма создания роли, а раздел логов выводит последние записи из MongoDB.
- Дополнена инструкция по установке зависимостей: `npm ci --prefix bot`.
- Workflow `ci.yml` устанавливает зависимости бэкенда этой же командой.
- Реализован модуль задач с REST API, тайм-трекером и KPI.
- Разъяснено требование наличия `.env` перед выполнением `docker compose config`.
- Добавлены обновлённые страницы входа, регистрации и профиля на основе TailAdmin.
- AuthContext теперь поддерживает функции `login` и `register`.
- Добавлен скрипт `create_env_from_exports.sh` для генерации `.env` из текущего
  окружения.
- Интерфейс фронтенда переведён на полный дизайн TailAdmin с иконками `@heroicons/react`.
- Реализована канбан-доска задач и поддержка drag&drop.
- Drag&drop реализован через `@hello-pangea/dnd`, библиотеку с поддержкой React 19.
- Скрипт обновлён: проверяет наличие `.env.example`, создаёт файл только при
  отсутствии и использует значения из окружения или дефолты.
- Интегрирован упрощённый Dashboard на базе TailAdmin и добавлен tsconfig во фронтенде.
- Dashboard теперь отображает метрики задач и график активности за неделю.
- В интерфейс добавлены компоненты из React TailAdmin demo: KPI-блоки и NotificationBar на странице Tasks.
- Страница Tasks переработана: форма добавления и таблица задач получили классы TailAdmin.
- Архив free-react-tailwind-admin-dashboard-main.zip удалён, стили синхронизированы с проектом TailAdmin React.
- Уточнено: при блокировке `nextjs.org` сборка фронтенда требует настроить прокси или другую среду с интернет‑доступом.
- Добавлен скрипт `audit_dependencies.sh` для проверки зависимостей.
- Обновлены `ROADMAP.md`, `README.md` и `AGENTS.md`.
- Добавлен модуль `bot/src/config.js` для чтения переменных окружения.
- Домен Railway изменён на `railway.com`, в `AGENTS.md` добавлены пользовательские инструкции.
- Уточнена инструкция по установке CLI `@railway/cli`: добавлены рекомендации по установке через прокси или архив GitHub Releases при ошибке `connect ENETUNREACH`.
- Начата настройка автоматического деплоя на Railway.
- Добавлена подробная инструкция по настройке бота через BotFather и скрипт `set_bot_commands.sh` с шаблоном команд.
- Расширена валидация API, усложнены миграции и сиды MongoDB, админ‑панель получила разделы "Логи" и "Роли".
- Установлена зависимость `@heroicons/react` и добавлена проверка наличия элемента `#root` во фронтенде для устранения ошибки React #130.
- Добавлено уточнение: ответ `404` на `GET /dashboard/` означает отсутствие собранного фронтенда; добавлены инструкции по пересборке.
- Добавлены разделы "Проекты", "Отчёты", "Админ" и "Профиль" вместо старых пунктов меню.
- На этих страницах появились формы добавления пользователей, проектов и фильтрации отчётов.
- Добавлено уведомление об успешном создании задач на странице `/dashboard/tasks`.
- Указано, что после обновления зависимостей следует запускать `npm --prefix bot/web install` и `npm --prefix bot run build-client`.
- В `next.config.ts` включена опция `trailingSlash`, чтобы `/dashboard` отвечал без 404 после обновления страницы.
- В документации добавлены команды с сохранением логов сборки в `/tmp`.
- Исправлены предупреждения ESLint и обновлены разделы README и ROADMAP.
- API проверяет наличие файлов в `bot/public` и при необходимости запускает `npm run build-client`.
- Исправлена ошибка React 130: каждому элементу меню задан собственный `icon`.
- Добавлен скрипт `build_client.sh` для автоматической сборки фронтенда и обновлены инструкции в документации.
- В `ROADMAP.md` появился раздел «В разработке».
- Добавлены issue templates и файл `CONTRIBUTING.md`.
- Реализована регистрация и авторизация пользователей через JWT, добавлена страница профиля.
- Создан новый workflow `ci.yml` для запуска тестов backend и frontend.
- Фронтенд переведён на React + Vite и Tailwind.
- Настроены Jest, Supertest и Husky.
- API документирован через Swagger, добавлена страница `/api-docs`.
- В GitHub Actions добавлена проверка линтера и тестов.
- Реализованы скрипты миграций и сидов MongoDB.
- Создана базовая админ‑панель пользователей и логов.
- Регистрация через `/api/auth/register` возвращает JWT,
  добавлены интеграционные тесты регистрационных маршрутов.
- Бот отправляет ссылку на мини‑приложение сразу после `/start`.
- Добавлен раздел "Обзор текущего состояния" в README с плюсами и минусами проекта.
- Страница `/dashboard/tasks` подключена к API и отображает данные из MongoDB.
- Реализована форма создания задач на этой странице.
- Добавлен файл `docs/telegram_bot_manual.md` с инструкцией по настройке команд и вебхуков Telegram-бота.
- Исправлены типы в `api.ts` и пути импорта компонентов для этой страницы.
- Базовая конфигурация ESLint добавлена в корень проекта; команда `npx eslint bot/src` выполняет проверку.
- Добавлен модуль `telegramApi.js` и поддержка `sendPhoto`, редактирования сообщений и inline-режима.
- В API внедрены `helmet`, `cors` и `express-validator`, расширены скрипты миграций и сидов.
- Добавлена рекомендация по устранению ошибки `lstat /client` при `docker compose build`.

- Добавлен Prettier во фронтенд и градиентный фон из шаблона React Vite Tailwind.
- В API реализован fallback `app.get('/{*splat}')` для SPA, ошибка 404 при обновлении страниц устранена.
- Для этого маршрута добавлено ограничение частоты запросов.
- Исправлена ошибка запуска `npx eslint bot/src` за счёт предварительной установки зависимостей (`npm --prefix bot install`).
- Обновлена инструкция по работе с Railway: используется CLI `@railway/cli`.
- Бот регистрирует пользователей через /start и даёт админам команды управления пользователями.
- Обновлены зависимости для устранения предупреждений безопасности; добавлена инструкция по регулярной проверке `npm audit`.
- Добавлен маршрут `/api/tasks/:id` для получения одной задачи.
- Запрос к этому маршруту теперь ограничивается 100 обращениями за 15 минут.
- Добавлен лимит 5 запросов в минуту на `/api/auth/login`.
- Добавлен лимит для `/api/groups`, `/api/users`, `/api/roles`, `/api/logs` и
  `/api/tasks/:id/status` (100 обращений за 15 минут).
- Добавлены тесты безопасности и проверки лимитов запросов.
- Удалены устаревшие опции подключений MongoDB, предупреждения драйвера исчезли.
- Маршруты `/auth/register` и `/auth/login` валидируют входные данные через `express-validator`.
- Добавлен отчёт Lighthouse от 24.06.2025 (docs/lighthouse_20250624.md).
- Добавлен отчёт Lighthouse от 26.06.2025 (docs/lighthouse_20250626.md).
- Страница `/roles` получила оформление TailAdmin для формы и списка ролей.
- Добавлены утилиты `.btn*` и обновлены формы (пользователи, проекты, фильтр отчётов) в стиле TailAdmin.
- Добавлено расширенное руководство TailAdmin (docs/extended_tailadmin_guide.md).
- Реализован контекст `ToastProvider` с возможностью отображать несколько уведомлений `NotificationBar`.
- Добавлен маршрут `DELETE /api/tasks/:id` и кнопка удаления задачи в интерфейсе.
- Страница `/tasks` перенаправляет на `/login`, если API вернул 401 или 403.
- Страницы `Админ`, `Проекты` и `Логи` оформлены карточками TailAdmin и используют breadcrumbs.
- Форма создания задачи открывает мини‑карту через ссылку `maps/embed` и кнопку «Карта». Скопированные ссылки «Поделиться» сокращаются и сохраняются в полях `start_location_link` и `end_location_link`.
- В модальном окне карты отображается подсказка о кнопке «Поделиться», ссылка проверяется при подтверждении и показывает ошибку, если формат неверный.
- API получает настройку `helmet` с директивой `frame-src https://www.google.com`; в сочетании с `maps/embed` это убирает ошибку CSP.
- Обновлены версии `@aws-sdk/client-s3`, `@vitejs/plugin-react`, `prettier`,
  `react-router-dom` и `vite`, что устранило предупреждения npm об устаревших
  пакетах `lodash.isequal`, `lodash.get`, `inflight` и `glob`.
- Улучшено определение темы интерфейса: если сохранённое значение отсутствует, используется предпочтение браузера.
- Скрипт инициализации тёмной темы вынесен в файл `theme.js` и подключается в index.html, что устраняет нарушения CSP.
- Пользователи получают поле `roleId`; права проверяет middleware `checkRole`, роли можно назначать в админ‑панели.
- Sidebar можно свернуть до узкой панели шириной 20, остаются только иконки.
- Обновлена палитра: введены акценты `accentPrimary` и `accentSecondary`, серые
  оттенки сведены к `neutral-100`, `neutral-300`, `neutral-500` и `neutral-900`.
- Все .jsx файлы во фронтенде конвертированы в TypeScript.
- Исправлено падение бота при пустом ответе команды `/list_tasks`: теперь выводится сообщение «Нет задач».
- Добавлена команда `/task_menu` с inline-кнопками для просмотра задач и открытия приложения.
- Добавлен скрипт `scripts/setup_tdweb.sh` для установки TDWeb и подготовки файлов WebAssembly. Планируется использование компонентов telegram-react.
- В раздел об ошибке 404 добавлено напоминание о сборке фронтенда: Docker запускает `npm run build-client` автоматически, но после правок его стоит выполнить повторно.

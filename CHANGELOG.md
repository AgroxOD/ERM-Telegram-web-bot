<!-- Назначение файла: список основных изменений. -->

# История изменений

- Админка принимает токен в параметре `?token=` и статику можно загружать без
  заголовка Authorization

- Система ролей дополнена числовыми масками доступа; middleware `checkRole` поддерживает проверку масок
- Удалены неиспользуемые функции assignTask, listAllTasks и команды загрузки файлов

- При обращении к пользователю Telegram ID приводится к числу,
  поиск задач экранирует спецсимволы регулярных выражений
- Функция `authFetch` перенаправляет на `/login` при отсутствии токена или статусе 401/403
- Исправлено обновление роли при подтверждении админского кода
- Срок действия JWT увеличен до семи дней
- Подтверждение кода администратора повышает существующего пользователя до роли `admin`
- Коды подтверждения содержат подпись типа пользователя
- Добавлена страница `/roles` для управления правами ролей
- Очередь сообщений ограничена 100 задачами и выводит ошибки
- Планировщик напоминаний использует lean и пакетное обновление
- Список задач кэшируется в localStorage и показывает индикатор загрузки
- Удалён AdminJS, админка `/admin` теперь использует кастомный бекенд
- Бекенд админки проверяет роль пользователя через JWT
- Меню бота упрощено: доступны только `/start` и `/register`
- Переработан расчёт маршрутов: используется сервис `OSRM-Odessa-Region` вместо GraphHopper erm-map
- Удалена страница «Справочники» и API `/api/v1/defaults` и `/api/v1/transports`; значения enum берутся из `taskFields.cjs`
- Уточнён владелец репозитория и email в SECURITY.md и CODEOWNERS
- В `setup_and_test.sh` тесты запускаются с флагом `--detectOpenHandles`
- Скрипт `setup_and_test.sh` проверяет `docker compose config` только при наличии команды `docker` и выводит предупреждение, если Docker не найден
- Функция `stripTags` рекурсивно удаляет HTML-теги в комментариях
- Добавлен скрипт `audit_deps.sh` и шаг CI для проверки зависимостей
- Низкоуровневые уязвимости игнорируются флагом `--audit-level high`
- Эндпойнты `/table`, `/nearest`, `/match` и `/trip` используют параметры `points` и `point`
- В README и документации указан новый репозиторий сервиса и переменная `OSRM_ALGORITHM`
- Кнопки статуса вынесены под форму и стали квадратными
- В верхней панели формы появилась кнопка «Сбросить»
- Кнопки действий внизу формы меняют цвет в зависимости от статуса
- Команда `/task_form_app` открывает форму новой задачи
- Зависимость `glob` зафиксирована на версии 7.2.3 для поддержки CommonJS
- Добавлена команда `/my_tasks` для вывода всех связанных задач
- Меню задач показывает только кнопку «Мои задачи»
- Исправлено отображение описания задачи в форме просмотра
- Действия «Принять», «Выполнено», «Изменить», «Отменить» обновляют задачу без закрытия сообщения
- Кнопка «Мои задачи» и команда `/list_tasks` выводят форму задачи с кнопками действий
- Все изменения задач пишутся в коллекцию логов
- Запросы к API и ответы сохраняются в журнал
- Бот безопасно редактирует сообщения, сравнивая текст
- Поля описания задач и комментариев ограничены 4096 символами
- Скрипт `install_bot_deps.sh` завершается успешно,
  если остаются только нерешённые слабые уязвимости
- Исправлена ошибка сборки CSS: неизвестный класс `bg-danger` приводил к пустому
  файлу стилей
- Фильтр `status` в `/api/v1/routes/all` защищён от инъекций
- Leaflet подключается локально, политика CSP разрешает тайлы OpenStreetMap
- Политика CSP разрешает подключение к сервису ORSM
  и `router.project-osrm.org`
- Удалённые задачи помещаются в коллекцию `archives` с суффиксом `-DEL`
- Страница `/tasks` получила экспорт таблицы в CSV и JSON
- На этой странице задачи создаются через `/api/v1/tasks` с полями
  `title` и `task_description`
- Пустые фильтры `/api/v1/routes/all` не отправляются
- Страница «Маршруты» строит путь через OSRM,
  порядок отображения зависит от сортировки задач
- Карта занимает верхнюю часть страницы, таблица закреплена снизу
- Старт и финиш маршрута отмечены интерактивными иконками
- Фильтры статуса убраны, задачи показаны таблицей с сортировкой,
  администратор может открыть их на редактирование
- Форма задачи фиксирована поверх карты, окно можно свернуть или развернуть,
  администратор может удалить задачу после подтверждения
- При открытии существующей задачи поля недоступны до нажатия «Редактировать»,
  исправлено самопроизвольное восстановление значений
- На странице «Маршруты» карта скрывается при открытии задачи
- В TaskDialog данные справочников загружаются один раз без перезапросов

- На форме входа можно отправить данные клавишей Enter
- В Tailwind добавлены палитры цветов `success`, `error` и `warning`
- Поле "Название" перемещено в начало формы задачи
- Некоторые поля формы объединены в строки по два, чтобы сократить высоту формы
- Справочники задач загружаются одним запросом для предотвращения ошибки 429
- Таблица ответов бота в `docs/bot_responses.md` полностью на русском
- В примерах `.env` и документации `ROUTING_URL` указывает на `https://orsm-production.up.railway.app/route`
- Добавлена переменная `VITE_ROUTING_URL` для веб-клиента
- Добавлена `docs/orsm.md` с инструкцией по запуску сервиса ORSM
- README обновлён ссылкой на документ `docs/orsm.md`
- Dockerfile корректно копирует каталог `bot`, сборка образа проходит без ошибок
- Добавлен `docs/railway_full_setup.md` с описанием полного развёртывания на Railway
- Клиент переведён на React 18 ради совместимости с TelegramUI
- Поддержан запуск в браузере через флаг `?browser=1`, telegram-apps-sdk не загружается
- Кнопка «Браузер» ведёт на `https://agromarket.up.railway.app/?browser=1`
- Клиент автоматически выбирает режим браузера при отсутствии `Telegram.WebApp`
- Завершение таймеров в `messageQueue` устранено
- Код бота и клиента объединён в каталоге `bot`
- Приоритет по умолчанию исправлен на форму «В течение дня»
- Добавлены скрипты `setup_and_test.sh`, `create_env_from_exports.sh`, `create_admin_user.js` и `check_bot_token.sh`
- MongoDB запускается с учётными данными `admin`/`admin` и healthcheck на `mongosh`
- Бот работает через polling, меню и сообщения синхронизируются скриптами
- Авторизация через одноразовый код; количество попыток ограничено
- Формы задач вынесены в общий модуль `taskFields.cjs`
- Добавлены глобальные обработчики ошибок и дополнительные тесты
- Команда `/whoami` показывает ID и статус пользователя
- Добавлена пагинация списка задач через параметры `page` и `limit`
- В модели задач появилось поле `slug`, генерируемое из названия
- Добавлены `robots.txt`, мета‑описание и aria‑метки для кнопок
- Модель задач расширена логистикой, закупками и работами
- Добавлены поля `transport_type`, `payment_method`, `priority`, `status`
- Веб-клиент получил редактор React Quill и поддержку TelegramUI
  через библиотеку @telegram-apps/sdk-react
- CRUD-маршруты `/api/v1/tasks` поддерживают полный набор полей
- Форма задач и контроллеры поддерживают поля `transport_type`,
  `payment_method` и выбор статуса
- Добавлены коллекции `DefaultValue` и `Transport` для справочников
- API `/api/v1/defaults/:name` и `/api/v1/transports` позволяет редактировать значения
- Для этих маршрутов добавлен rate limit и проверка входных данных
- Формы задач открываются поверх текущей страницы через параметры URL
- Сайдбар можно полностью скрыть и раскрыть
- При скрытом сайдбаре шапка растягивается, форма задач центрируется и занимает оставшееся пространство
- Макет формы адаптирован под мобильные устройства
- Интерфейс задач дополнен новой формой
- pm2 переведён в fork-режим, чтобы исключить конфликт polling
- Добавлены новые значения enum: "Построить", "Починить" для `task_type` и "Без оплаты" для `payment_method`
- Уточнён список допустимых `task_type` в документации
- Добавлена единая форма для создания и редактирования задач
- Название задачи теперь включает идентификатор вида `ERM_000001`
- API переведён на префикс `/api/v1`
- Изменён путь подключения к MongoDB на `ermdb`
- Добавлены переменные `RETRY_ATTEMPTS` и `RETRY_DELAY_MS`;
  по умолчанию выполняется 10 попыток подключения
- В формах задач отображается `request_id` и дата создания
- Поле "Ответственный" исключено, "Контролёр" поддерживает выбор нескольких
- Поля формы расположены в порядке: дата начала, срок выполнения, статус, приоритет и далее
- Кнопки "Карта" ведут на ссылку <https://maps.app.goo.gl/xsiC9fHdunCcifQF6> без iframe
- "Исполнител(и)ь" и "Контролёр" можно выбирать из списка по кнопке «+»
- Бот разворачивает короткие ссылки Google Maps и показывает координаты
- Форма задач также разворачивает короткие ссылки Google Maps
- В форме задачи при вставке ссылки поле скрывается, отображается адрес
- Добавлены поля `startCoordinates` и `finishCoordinates`
- Координаты точки теперь выводятся под ссылкой в форме
- Отправка null координат исключена, поля передаются только при наличии
- Появился эндпойнт `/api/v1/route` для расчёта расстояния
- В модель задач добавлено поле `route_distance_km`
- Добавлено поле `google_route_url` и автоматическая генерация ссылки маршрута
- Добавлен эндпойнт `/api/v1/routes/all` и страница «Маршруты»
- В форме появилось поле `start_date` для даты начала
- Автоподстановка финальной точки из стартовой отключена
- Выпадающие списки упоминаний удалены
- Скрипт `scripts/db/seed.js` создаёт задачу с приоритетом «Срочно»
- В списке задач доступны даты начала и дедлайн,
  администратор может менять статус и приоритет, добавлена сортировка
- После создания задачи список на странице `/tasks` обновляется автоматически,
  появилась кнопка «Обновить задачи»
- Добавлена оптимизация маршрутов для 1–3 машин, кнопка «Просчёт маршрута»
- Добавлен выбор метода оптимизации: angle или trip
- Оптимизированные маршруты отображаются на карте разными цветами
- Добавлена кнопка «Сбросить" для очистки наложенных маршрутов
- Для каждого маршрута формируется ссылка Google Maps (до 10 точек)
- Меню расчёта расположено между картой и таблицей задач,
  ссылки выводятся в меню и не открываются автоматически
- При расчёте нескольких машин задачи распределяются между всеми авто
- README дополнен примером JSON со `startCoordinates` и `finishCoordinates`
- В `docs/telegram_bot_manual.md` описано разворачивание коротких ссылок Google Maps
- Статус задач переведён на русский, добавлено поле `completed_at`
- Сервис ORSM поддерживает `/table`, `/nearest`, `/match` и `/trip`
- Координаты запросов к ORSM валидируются для защиты от SSRF

### Безопасность

- Сообщение о загрузке `BOT_TOKEN` не раскрывает даже начало значения

- Исправлены пути API в клиенте: добавлен префикс /api/v1
- Удалены неиспользуемые состояния `roles` и `groups` в компоненте `TaskDialog`
- Провайдер `ThemeProvider` корректно экспортируется из файла `ThemeContext.tsx`
- Провайдеры `SidebarProvider` и `ToastProvider` экспортируются из файлов контекста
- Исправлены зависимости `useEffect` в `TaskDialog`, предупреждения ESLint исчезли
- Исправлена ошибка линтера: состояние `selectedAction` используется для подсветки кнопок
- Кнопка \xC2\xABИзменить\xC2\xBB включает режим смены статуса
- Добавлен POST /api/v1/logs для произвольной записи
- Кнопки действий перемещены внутрь формы, теперь всегда находятся внизу окна
- Исправлен порядок обработчиков «Выполнено» и «Отменить», кнопки корректно меняют статус задачи
- Кнопка «Мои задачи» выводит все связанные задачи пользователя
- Команда `/task_info` показывает компактное описание задачи
- Вывод задачи в чате форматируется Markdown, добавлена кнопка маршрута
- Появились новые поля: тип задачи, дата начала, список исполнителей и создатель
- В чате отображается `task_description` вместо `comment`
- Превью ссылок в сообщениях задачи отключено
- Маршрут `/admin` объявлен как `/*splat` для Express 5, исправлен wildcard
- В комментариях API указан маршрут `/*splat` вместо устаревшего `/{*splat}`
- Перед обновлением зависимостей выполняется `npm outdated` и тестирование скриптами
- Авторизация проверяет роль пользователя, код отправляется только в Telegram
- Разделы «Роли» и «Логи» перенесены на `/admin`
- Страница `/admin` показывает заглушку для неадминов
- В API поле username теперь содержит Telegram ID
- Внутри `/admin` разделы переключаются вкладками «Роли» и «Логи»
- Имена пользователей отображаются ссылками на их Telegram ID
- В сообщениях задач исполнители, контролёры и создатель выводятся по имени
- Запросы `/api/v1/users` и `/api/v1/departments` выполняет только админ, обычные пользователи не перенаправляются на `/login`
- Исправлена ошибка инициализации переменной `isAdmin` в TasksPage, из-за которой падала авторизация
- Авторизация отправляет код входа в зависимости от роли пользователя
- Дашборд удалён, административные страницы перенесены на /cp
- На странице профиля теперь можно изменить ФИО и мобильный номер, добавлено поле mobNumber в схему пользователя. Путь /cp открывает панель управления, ссылка на неё доступна в меню админа.
- API пользователей теперь возвращает поле `telegram_username` с оригинальным username.
- Иконка меню профиля заменена на UserCircleIcon без заглушки.
- Меню профиля удалено, кнопка «Админка» находится в шапке.
- Исправлены ошибки ESLint в контроллерах routes и tasks
- Исправлена загрузка списка пользователей в TasksPage для неадминистраторов
- Исправлена загрузка задач в канбане при объектном ответе API
- Имена исполнителей и контролёров в форме подтягиваются из API и показывают имя
- Добавлены тесты админских маршрутов
- Исправлено определение роли в таблицах задач при смене токена
- Добавлены тесты доступа к маршруту `/api/v1/users`
- Скрипт create_admin_user.js также записывает roleId администратора
- Создание пользователя добавляет поле name и roleId по умолчанию
- Добавлен файл docs/architecture.md с описанием модулей
- Настроен Prettier и команда `npm run format`
- telegramApi.call повторяет запрос с экспоненциальной задержкой
- Добавлен INCIDENT_RESPONSE.md с инструкцией по смене токена
- Исправлена обработка кэша задач в tasks.js
- Workflow CI использует Node.js 20 для единообразия окружения
- При ошибке 409 бот повторяет запуск через 3 секунды и делает до 5 попыток
- Форма задачи остаётся открытой после сохранения, выбранные исполнители отображаются по имени
- Обновлены файлы package-lock.json клиента, docker build выполняется без ошибок
- JWT помещается в cookie HttpOnly
- API защищён от CSRF при помощи lusca.csrf, сессии хранятся через connect-mongo
- Сессия хранится в MongoDB, cookie передаётся только по HTTPS, маршруты задач ограничены rate limit
- CSRF-токен передается через cookie XSRF-TOKEN и добавляется в заголовок автоматической обёрткой fetch
- Маршруты `/api/v1/auth/send_code` и `/api/v1/auth/verify_code` не требуют CSRF-токена
- Тесты используют secure cookie только в продакшене
- Обновлена зависимость form-data до 4.0.4 для устранения критической уязвимости

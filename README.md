<!-- Назначение файла: краткая документация по проекту. -->

# Telegram Task Manager Bot + Mini App

Код бота и веб-интерфейса находится в каталоге `bot`.

## Возможности
- Управление задачами через чат и мини‑приложение
- REST API доступно на префиксе `/api/v1`, описание на `/api-docs`
- Напоминания и уведомления
- Команда `/whoami` показывает ID и статус
- Авторизация через одноразовый код
- Пагинация списка задач через параметры `page` и `limit`
- Поле `slug` формируется автоматически из названия задачи
- Улучшенная доступность и SEO: `robots.txt`, `aria-label` и meta description
- Модель задач включает разделы логистики, закупок и работ
- Поддерживаются enum `task_type`, `transport_type`, `payment_method`, `priority`, `status`
- В тип задач добавлены варианты "Построить" и "Починить", способ оплаты теперь поддерживает "Без оплаты"
- ID формата `ERM_000001` создаётся автоматически и используется в названии
- Название задачи сохраняется в виде `ERM_000001 Название`, а в форме отображается с датой создания
- Веб-интерфейс учитывает `transport_type`, `payment_method` и `status`
- Добавлены справочники значений. Запросы `/api/v1/defaults/:name` и `/api/v1/transports`
  позволяют получать и редактировать списки по умолчанию
- Для этих запросов действует ограничение частоты и строгая валидация
- Редактор текста реализован на React Quill с использованием TelegramUI
- Мини-приложение работает на React 18 для совместимости с TelegramUI
- Для запуска в обычном браузере добавьте `?browser=1` в адрес, SDK Telegram не потребуется
- Кнопка «Браузер» в меню открывает `https://agromarket.up.railway.app/?browser=1`
- Отделы также доступны для редактирования через `/defaults` и `/api/v1/departments`
- При обновлении отдела имя проверяется на тип строки для защиты от инъекций
- PM2 запускает API и бота в fork-режиме, предотвращая конфликт polling
- Дополнены enum-поля задач: добавлены варианты "Построить" и "Починить", оплата теперь поддерживает "Без оплаты"
- Интерфейс создания и редактирования задач объединён в одну форму
- Поле "Ответственный" удалено, "Контролёр" допускает выбор нескольких исполнителей
- Форма начинается со статуса и приоритета, далее идут остальные поля
- Кнопки "Карта" открывают всплывающее окно с Google Maps, центр на Одессе
- "Исполнител(и)ь" и "Контролёр" поддерживают добавление нескольких через кнопку «+»



## Быстрый старт
1. Клонируйте репозиторий и создайте `.env` на основе `.env.example`:
   ```bash
   git clone https://github.com/AgroxOD/agrmcs.git
   ./scripts/create_env_from_exports.sh
   ```
2. Установите зависимости и запустите Docker Compose:
   ```bash
   npm ci --prefix bot
   docker compose up -d
   ```
3. При необходимости запустите локальный telegram-bot-api и укажите `BOT_API_URL` в `.env`.

Для проверки подключения к MongoDB выполните:
```bash
npm --prefix bot run check:mongo
```

Для аудита зависимостей существует скрипт:
```bash
./scripts/audit_deps.sh
```
Он запускается автоматически в CI и сообщает о конфликтующих пакетах.

## Тесты
```bash
./scripts/setup_and_test.sh
```
Скрипт выполняет Jest с флагом `--detectOpenHandles`, чтобы выявлять незавершённые асинхронные операции.

## CI/CD
GitHub Actions используют тот же скрипт; workflow `docker.yml` поднимает MongoDB для проверки.

## Создание администратора
```bash
NODE_PATH=./bot/node_modules node scripts/create_admin_user.js <id> [username]
```

## Дополнительные материалы
Подробности смотрите в каталоге `docs/`, историю изменений — в `CHANGELOG.md`, планы — в `ROADMAP.md`.
- Все запросы клиента используют единый префикс `/api/v1`

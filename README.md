<!-- Назначение файла: краткая документация по проекту. -->

# Telegram Task Manager Bot + Mini App

Код бота и веб-интерфейса находится в каталоге `bot`.

## Возможности
- Управление задачами через чат и мини‑приложение
- REST API доступно на префиксе `/api/v1`, описание на `/api-docs`
- Веб-панель администратора находится на `/admin` и использует AdminJS
  (модули `@adminjs/express` и `@adminjs/mongoose` подключаются статически,
  `@adminjs/mongoose` импортируется через `* as`, сам AdminJS через `default`)
- Инициализация AdminJS выполняется только после подключения к MongoDB
- Напоминания и уведомления
- Команда `/register` проверяет и регистрирует пользователя
- Авторизация через одноразовый код
- Отправка формы авторизации возможна клавишей Enter
- Сборка CSS не содержит ошибок, стили работают во всех разделах
- Пагинация списка задач через параметры `page` и `limit`
- Поле `slug` формируется автоматически из названия задачи
- Улучшенная доступность и SEO: `robots.txt`, `aria-label` и meta description
- Модель задач включает разделы логистики, закупок и работ
- Поддерживаются enum `task_type`, `transport_type`, `payment_method`, `priority`, `status` (значения статуса на русском)
- Приоритет по умолчанию называется «В течение дня»
- В тип задач добавлены варианты "Построить" и "Починить", способ оплаты теперь поддерживает "Без оплаты"
- ID формата `ERM_000001` создаётся автоматически и используется в названии
- Название задачи сохраняется в виде `ERM_000001 Название`, а в форме отображается с датой создания
- Веб-интерфейс учитывает `transport_type`, `payment_method` и `status`
- Для оформления кнопок и уведомлений в Tailwind определены палитры `success`,
  `error` и `warning`
- Кнопки действий в форме задачи подсвечиваются при выборе
- Описание задачи отображается в режиме чтения
- Значения enum хранятся в `shared/taskFields.cjs` и используются по умолчанию
- Редактор текста реализован на React Quill с использованием TelegramUI
- Мини-приложение работает на React 18 для совместимости с TelegramUI
- Для запуска в обычном браузере добавьте `?browser=1` в адрес, SDK Telegram не потребуется
- Кнопка «Браузер» в меню открывает `https://agromarket.up.railway.app/?browser=1`
- Клиент автоматически переключается в режим браузера, если объект `Telegram.WebApp` отсутствует
- Отделы редактируются через `/api/v1/departments`
- При обновлении отдела имя проверяется на тип строки для защиты от инъекций
- Имя отдела записывается через `$set` для надёжного обновления
- PM2 запускает API и бота в fork-режиме, предотвращая конфликт polling
- Зависимость `glob` фиксирована на версии 7.2.3 для поддержки CommonJS
- Дополнены enum-поля задач: добавлены варианты "Построить" и "Починить", оплата теперь поддерживает "Без оплаты"
- Интерфейс создания и редактирования задач объединён в одну форму
- Поле "Ответственный" удалено, "Контролёр" допускает выбор нескольких исполнителей
- Форма начинается с даты начала и срока выполнения, затем статус и приоритет
- Кнопки "Карта" ведут на ссылку <https://maps.app.goo.gl/xsiC9fHdunCcifQF6> без iframe
- Бот распознаёт короткие ссылки Google Maps и возвращает полную ссылку с координатами
- Форма задач также разворачивает короткие ссылки Google Maps
- После вставки ссылки поле ввода скрывается и отображается текст с адресом
- В форму задач добавлены переменные `startCoordinates` и `finishCoordinates`
- Под ссылкой показываются извлечённые координаты, значения отправляются в API
- Пустые координаты не отправляются, чтобы избежать ошибки 400
- Добавлен эндпойнт `/api/v1/route` для расчёта маршрута
- Добавлен `/api/v1/routes/all` для получения маршрутов
- В задаче сохраняется `route_distance_km` с расстоянием в километрах
- Поле `google_route_url` содержит ссылку на маршрут Google Maps
- При завершении задачи фиксируется время в поле `completed_at`
- Появилось поле "Дата начала" с сохранением в `start_date`
- Поле "Название" расположено первым в форме
- Некоторые поля формы объединены попарно в одну строку для компактности
- Выпадающие списки для упоминаний удалены из формы
- "Исполнител(и)ь" и "Контролёр" поддерживают добавление нескольких через кнопку «+»
- Неиспользуемые состояния `roles` и `groups` убраны из компонента `TaskDialog`
- Списки значений загружаются из `taskFields.cjs` без вызова API
- Контексты React вынесены в отдельные файлы, предупреждения `react-refresh` устранены
- Провайдеры контекстов экспортируются из файлов контекста для корректного импорта
- Формы задач открываются поверх текущей страницы через параметры `?newTask` и `?task`
- Форма задачи всегда остаётся поверх карты, есть кнопка сброса изменений и возможность развернуть окно
- Администратор может удалить задачу из формы с подтверждением
- При открытии существующей задачи поля заблокированы, чтобы редактировать нажмите «Редактировать»
- Кнопки «Принять», «Выполнено», «Изменить», «Отменить» закреплены внизу внутри формы и становятся зелёными при соответствующем статусе
- Кнопки расположены в два ряда по две
- POST `/api/v1/logs` позволяет добавлять сообщения в журнал
- Боковое меню можно полностью свернуть и раскрыть кнопкой меню
- При скрытом меню шапка занимает всю ширину, форма задач центрируется под ней
- Ответы бота перечислены в `docs/bot_responses.md`; таблица полностью на русском
- Меню задач в чате показывает только кнопку «Мои задачи»
- Кнопки «Принять», «Выполнено», «Изменить», «Отменить» обновляют задачу и не закрывают сообщение
- Кнопки «Выполнено» и «Отменить» корректно меняют статус задачи
- В сообщении указываются тип задачи, дата начала, исполнители и создатель
- Скрипт `scripts/db/seed.js` заполняет базу задачей с приоритетом «Срочно»
- Все изменения задач записываются в коллекцию логов
- API записывает каждый запрос и ответ в логи
- Команды бота используют безопасное редактирование сообщений
- Функция `stripTags` рекурсивно удаляет HTML-теги в комментариях
- Страница списка задач показывает даты начала и дедлайн,
  приоритет и статус можно менять администратором, добавлена сортировка
- После создания задачи список на странице `/tasks` обновляется автоматически,
  добавлена кнопка «Обновить задачи»
- На странице `/tasks` можно экспортировать полную таблицу задач в CSV и JSON,
  строки удобно вставлять в Google Sheets или Excel
- Создание задачи на странице `/tasks` отправляет данные в `/api/v1/tasks`
  с полями `title` и `task_description`
- При удалении задачи она переносится в коллекцию «archives» с суффиксом `-DEL`
  - Появилась страница «Маршруты» на основе OSRM-frontend
  - Путь маршрута строится через OSRM, задачи определяют порядок отображения
  - Карта занимает верхнюю часть страницы, таблица закреплена снизу
  - При наведении на старт и финиш маршрута показывается название задачи со ссылкой
  - Leaflet подключается локально, политика CSP разрешает тайлы OpenStreetMap
  - Политика CSP разрешает подключение к сервису OSRM и `router.project-osrm.org`
  - Сервис OSRM поддерживает `/table`, `/nearest`, `/match` и `/trip`
  - Координаты запросов к маршрутам проверяются на корректность
  - Параметры фильтра отправляются только при заполнении,
    `status` проверяется как строка и не допускает инъекций
  - Фильтры статуса и отдела убраны,
    задачи выводятся таблицей с сортировкой и фильтрами,
    администратор может открывать их на редактирование
  - Таблица маршрутов показывает колонку «Статус» с фильтром,
    выводятся все задачи без скрытия по статусу
  - Добавлена кнопка «Просчёт маршрута» с выбором количества транспорта (1–3)
  - Рядом доступен выбор метода оптимизации: angle или trip
  - Оптимизированные маршруты накладываются на карту разными цветами,
    доступна кнопка «Сбросить" для очистки
  - Меню управления оптимизацией расположено между картой и списком задач
  - Ссылки Google Maps отображаются в меню оптимизации под картой
    и не открываются автоматически
  - Если выбрано несколько машин, задачи распределяются между всеми авто
  - В чате описание задачи выводится из поля `task_description`
  - Ссылки в сообщениях задач отправляются без превью

## Пример JSON задачи
```json
{
  "title": "ERM_000001 Проверить склад",
  "startCoordinates": { "lat": 50.4501, "lng": 30.5234 },
  "finishCoordinates": { "lat": 50.4422, "lng": 30.545 },
  "route_distance_km": 2.5,
  "google_route_url": "https://www.google.com/maps/dir/?api=1&origin=50.4501,30.5234&destination=50.4422,30.545"
}
```



## Быстрый старт
1. Клонируйте репозиторий и создайте `.env` на основе `.env.example`:
   ```bash
   git clone https://github.com/AgroxOD/agrmcs.git
   ./scripts/create_env_from_exports.sh
   ```
2. Установите зависимости и запустите Docker Compose:
   ```bash
   npm ci --prefix bot
   docker compose up -d
   ```
3. При необходимости запустите локальный telegram-bot-api и укажите `BOT_API_URL` в `.env`.
   В консоль выводятся только первые символы `BOT_TOKEN` для отладки.
4. Если MongoDB запускается дольше приложения, увеличьте число попыток подключения:
   ```bash
   RETRY_ATTEMPTS=10
   RETRY_DELAY_MS=5000
   ```
   Эти переменные задают количество попыток и задержку между ними.
5. Для расчёта маршрута задайте `ROUTING_URL` так:
   ```bash
   ROUTING_URL=https://orsm-production.up.railway.app/route
   VITE_ROUTING_URL=https://orsm-production.up.railway.app/route
   # Переменная OSRM_ALGORITHM управляет выбором `ch` или `mld` в сервисе маршрутов
   ```
   Подробности развёртывания описаны в `docs/orsm.md`.
   Полное развёртывание всего проекта на Railway описано в `docs/railway_full_setup.md`.

## Сборка Docker-образа
Dockerfile находится в корне репозитория и копирует файлы из каталога `bot/`.
Соберите и запустите контейнер так:
```bash
docker build -t telegram-task-bot .
docker run --env-file .env -p 3000:3000 telegram-task-bot
```

Для проверки подключения к MongoDB выполните:
```bash
npm --prefix bot run check:mongo
```

Для аудита зависимостей существует скрипт:
```bash
./scripts/audit_deps.sh
```
Он запускается автоматически в CI и сообщает о конфликтующих пакетах.
Низкоуровневые уязвимости пропускаются флагом `--audit-level high`.
В CI используется `scripts/install_bot_deps.sh`, который не прерывается,
если остаются только нерешённые слабые уязвимости.

## Тесты
```bash
./scripts/setup_and_test.sh
```
Скрипт выполняет Jest с флагом `--detectOpenHandles`, чтобы выявлять незавершённые асинхронные операции.
При наличии установленного Docker и файла `docker-compose.yml` происходит проверка конфигурации через `docker compose config`. Если Docker отсутствует, скрипт выводит предупреждение.

## CI/CD
GitHub Actions используют тот же скрипт; workflow `docker.yml` поднимает MongoDB для проверки.

## Создание администратора
```bash
NODE_PATH=./bot/node_modules node scripts/create_admin_user.js <id> [username]
```

## Дополнительные материалы
Подробности смотрите в каталоге `docs/`, историю изменений — в `CHANGELOG.md`, планы — в `ROADMAP.md`.
- Все запросы клиента используют единый префикс `/api/v1`

## Контакты
По вопросам безопасности пишите на [security@agro-market.ua](mailto:security@agro-market.ua).
Владелец репозитория — [@AgroxOD](https://github.com/AgroxOD).

<!-- Назначение файла: документация проекта и общие инструкции. -->
# Telegram Task Manager Bot + Mini App

[![Docker CI](https://github.com/user/agrmcs/actions/workflows/docker.yml/badge.svg)](https://github.com/user/agrmcs/actions/workflows/docker.yml) [![Release](https://github.com/user/agrmcs/actions/workflows/release.yml/badge.svg)](https://github.com/user/agrmcs/actions/workflows/release.yml)

Файл описывает проект и способы его развертывания.

Каталог `bot` содержит код бота и статическое мини-приложение Telegram.
Для сборки используется один `Dockerfile`. Мини‑приложение запускается ботом и содержит веб‑интерфейс управления.
Дополнительная информация о плане разработки представлена в файле `ROADMAP.md` (включая раздел «В разработке»), а история изменений ведётся в `CHANGELOG.md`.
За инструкцией по настройке команд и вебхуков бота обратитесь к файлу `docs/telegram_bot_manual.md`. В нём описана работа с BotFather и скрипт `scripts/set_bot_commands.sh` для установки меню. Документация API приведена в `docs/api_reference.md` и доступна через `/api-docs`.
Документация API приведена в `docs/api_reference.md` и доступна через `/api-docs`.
Карта запросов между API и базой описана в `docs/db_request_map.md`.


## Быстрый старт

### Требования
- Docker и Docker Compose
- Учётная запись MongoDB Atlas

### Локальный запуск
1. Склонируйте текущий репозиторий с модифицированным кодом:
   ```bash
   git clone https://github.com/AgroxOD/agrmcs.git
   ```
   Каталог `bot` уже содержит необходимые исходники.
2. Создайте файл `.env` на основе примера или существующих переменных окружения.
   Копирование примера:
   ```bash
   cp .env.example .env
   ```
   Автоматическая генерация:
   ```bash
   ./scripts/create_env_from_exports.sh
   ```
   Скрипт берёт список ключей из `.env.example`, подставляет значения из текущего
   окружения или оставляет дефолтные и создаёт файл.
  `.env` не хранится в репозитории и перечислен в `.gitignore`.
  Все переменные считываются централизованным модулем `bot/src/config.js`,
  который прекращает запуск при отсутствии обязательных значений.
3. Установите зависимости серверной части:
   ```bash
   npm ci --prefix bot || npm --prefix bot install
   ```
   Если `package-lock.json` отсутствует, сперва выполняется `npm install` для его создания. Без зависимостей линтер `npx eslint bot/src` выдаст ошибку `Cannot find module '@eslint/js'`.
  Для входа в мини‑приложение задайте `ADMIN_EMAIL` и `ADMIN_PASSWORD`.
  Перед запуском можно проверить конфигурацию командой `docker compose config`. Без созданного `.env` она выдаст ошибку о его отсутствии.
4. В переменную `CHAT_ID` запишите ID чата для уведомлений. Его можно узнать через бота `@userinfobot`.
5. Запустите контейнеры:
  ```bash
  docker compose up --build
  ```
  Compose соберёт образ бота и запустит MongoDB.
  Если при сборке возникла ошибка `lstat /bot/client: no such file or directory`,
  убедитесь, что команда выполняется из корня репозитория и директория
  `bot/web` присутствует.
  Мини‑приложение открывается ссылкой из команды `/app`.
  После входа на `/login` страница `/dashboard/tasks` загружает задачи из MongoDB.
  Добавлены маршруты регистрации и входа `/api/auth/register`, `/api/auth/login` и страница `/profile`.
  Для проверки сервера запросите GET `/health`.
  При занятости порта 3000 укажите другой `HOST_PORT` в `.env`.
  Чтобы остановить сервисы, выполните `docker compose down`.

## Миграции и сиды
- `node scripts/db/migrate.js` создаёт индексы в MongoDB
- `node scripts/db/seed.js` наполняет базу тестовыми данными

При необходимости можно собрать единый образ из корневого `Dockerfile`. Используется многоступенчатая сборка для уменьшения размера:
```bash
docker build -t task-manager .
docker run --env-file .env -p ${HOST_PORT:-3000}:${PORT:-3000} task-manager
```

### Развёртывание на [Railway](https://railway.com)
1. Создайте новый проект и подключите репозиторий.
2. Выберите Node `20` или совместимую версию.
3. В настройках задайте переменные из `.env.example`.
4. Railway автоматически использует `Procfile` из корня. В нём теперь выполняется
   сборка интерфейса перед стартом, что предотвращает ошибку `404` на `/dashboard`.
5. Установите CLI для проверки статуса:
   ```bash
   npm install -g @railway/cli
   ```
   При ошибке `connect ENETUNREACH` укажите прокси через `HTTP_PROXY` и `HTTPS_PROXY` либо скачайте архив из GitHub Releases.
   После установки проверьте:
   ```bash
   railway status
   ```
6. Нажмите Deploy и дождитесь запуска контейнера.

## Интерфейс

Фронтенд построен на React + Vite + Tailwind и использует элементы из демонстрационного проекта TailAdmin. Стили обновлены с помощью архива `free-react-tailwind-admin-dashboard-main.zip`, поэтому меню и шапка максимально повторяют демо. Помимо разделов Dashboard, Tasks, Logs и Roles добавлена страница `/charts` с примером графика на основе `react-chartjs-2`. При создании задач выводится `NotificationBar` со статусом `success`.

## Структура проекта
```
project-root/
├── ROADMAP.md          # план разработки
├── CHANGELOG.md        # история версий
├── bot/                # исходный код Telegram-бота
│   └── Dockerfile      # контейнер бота
├── .env.example        # пример переменных
├── .env                # локальные переменные (не добавляйте в git)
├── docker-compose.yml  # локальное развертывание
└── README.md           # документация
```

## Лицензия
Проект распространяется под лицензией MIT.
## Релизы
Релизы формируются автоматически при создании тега `vX.Y.Z`. После публикации можно скачать архив и Docker-образ.
```bash
docker pull agrmcs:vX.Y.Z
```
Или установить через npm:
```bash
npm install agrmcs@vX.Y.Z
```


## CI с Docker
Файл `.github/workflows/docker.yml` проверяет `docker-compose.yml` и собирает образы с помощью `docker compose` при каждом pull request.

## Лучшие практики CI/CD
Надёжный pipeline помогает быстрее доставлять изменения. В базовый набор стоит включить:
- отдельные workflow для тестов, линтера и сборки Docker;
- кеширование `node_modules` и зависимостей фронтенда;
- проверку наличия переменных окружения и генерацию `.env` через `create_env_from_exports.sh`;
- сканирование зависимостей на уязвимости;
- автоматический деплой на Railway после успешных тестов.


## Внесение вклада
Перед разработкой создайте задачу через шаблон в `.github/ISSUE_TEMPLATE` и изучите [CONTRIBUTING.md](CONTRIBUTING.md). При каждом изменении обновляйте документацию и `CHANGELOG.md`.
Основной шаблон теперь называется `task.yml` и содержит поля локации, срока и ответственных лиц.

## Безопасность
Файл `.env` содержит секреты и предназначен только для локальной разработки.
Создайте его на основе `.env.example` и не публикуйте в репозитории.
Для продакшена рекомендуем использовать Docker Secrets или сторонние хранилища
секретов, например [Vault](https://www.vaultproject.io/).

## Резервное копирование БД в R2
Для создания архива MongoDB и загрузки его в R2 выполните:
```bash
./scripts/backup_mongo_r2.sh
```
Скрипт использует переменные из `.env` и требует установленный `aws` CLI.

### Ошибка 404 на `/dashboard`
Если в логах появляется ответ `404` на `GET /dashboard/`, значит статический интерфейс не сгенерирован. Выполните сборку фронтенда:
```bash
npm --prefix bot run build-client > /tmp/npm_build.log 2>&1 && tail -n 20 /tmp/npm_build.log
```
Или воспользуйтесь скриптом:
```bash
./scripts/build_client.sh
```
Если команда завершается ошибкой `vite: not found`, сначала установите зависимости:
```bash
npm --prefix bot/web install > /tmp/npm_install.log 2>&1 && tail -n 20 /tmp/npm_install.log
```
Затем повторите сборку. Убедитесь, что каталог `bot/public` содержит статические файлы.
При пустой директории `bot/public` сервер выполнит сборку сам, но для актуализации интерфейса лучше запускать `npm --prefix bot run build-client` вручную.
После обновления зависимостей повторяйте `npm --prefix bot/web install` и `npm --prefix bot run build-client`.
Для PostCSS используйте плагин `@tailwindcss/postcss`, иначе сборка завершится ошибкой.
Если установка зависимостей блокируется, убедитесь в доступе к интернету или настройте прокси.
Если при установке выводится предупреждение `Unknown env config "http-proxy"`,
замените переменную окружения `http-proxy` на `HTTP_PROXY` или `npm_config_proxy`.
Если в браузере появляется ошибка `Minified React error #130`, чаще всего она вызываетcя попыткой отрисовать компонент `undefined`. Проверьте, что элементы бокового меню содержат свойство `icon`. Также убедитесь в наличии `<div id="root">` в HTML: в `main.tsx` добавлена явная проверка и сообщение об его отсутствии.



## Обзор текущего состояния

### Плюсы
- Чёткая бизнес-логика агро-операций и пользователей, REST API доступен сразу.
- Проект докеризирован, запуск происходит быстро через `docker-compose`.
- Пример `.env` и руководство по развёртыванию входят в репозиторий.
- Код разделён на слои: роуты, модели, сервисы.
- Фронтенд переписан на React + Vite и Tailwind.
- Админ‑панель подключена к API и отображает задачи из MongoDB.
- Добавлены страницы "Проекты", "Отчёты", "Админ" и "Профиль".
- Реализована канбан-доска задач на `/tasks/kanban`.
- Реализована регистрация пользователей, авторизация через JWT и страница личного кабинета.
- Страницы входа, регистрации и профиля используют стили TailAdmin.
- При создании задачи выводится уведомление об успехе.
- Поддерживаются чеклисты задач, учёт времени и KPI‑отчёты.
- Есть пример графиков и компонент `api.ts` для работы с API.
- Через модуль `telegramApi.js` доступны любые методы Telegram Bot API, реализованы `sendPhoto`, редактирование сообщений и inline-режим.
- Бот автоматически регистрирует пользователей и позволяет администраторам управлять списком пользователей и задач.
- ESLint проверяет весь серверный код.
- Внедрены `helmet` и `cors`, входные данные проверяются через `express-validator`.
- Для Express 5 добавлен fallback `app.get('/{*splat}')`, обновление страниц не приводит к `404`.
- Для fallback маршрута настроен rate limit, предотвращающий массовые запросы.

### Минусы
- Части бизнес‑логики ещё требуют доработки.

### Как улучшить
 - Продолжать покрывать тестами новую функциональность.
 - Регулярно выполнять `npm audit` и обновлять пакеты (см. `scripts/audit_dependencies.sh`).
 - Расширять документацию по сценариям использования API.
 - Настроить автоматический деплой на Railway (работа ведётся).

Эти шаги позволят ускорить развитие проекта.

### Итог

Проект представляет готовую базу и быстро разворачивается, но требует модернизации для полноценного продакшна. Интерфейс построен на React + Vite + Tailwind и использует элементы TailAdmin. В Dashboard отображаются динамические метрики и график задач на ApexCharts, данные берутся из API. При создании задач выводится уведомление. Код фронтенда форматируется Prettier.
С недавним обновлением стили взяты из архива `free-react-tailwind-admin-dashboard-main.zip`, что приблизило внешний вид к демо TailAdmin.

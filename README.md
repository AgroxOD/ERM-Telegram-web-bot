<!-- Назначение файла: документация проекта и общие инструкции. -->
# Telegram Task Manager Bot + Mini App

Файл описывает проект и способы его развертывания.

Каталог `bot` содержит код бота и статическое мини-приложение Telegram.
Для сборки используется один `Dockerfile`.
Панель администратора на базе AdminJS доступна по адресу `/admin` и встраивается через iframe в мини-приложение.

Дополнительная информация о плане разработки представлена в файле `ROADMAP.md`, а история изменений ведется в `CHANGELOG.md`.

## Быстрый старт

### Требования
- Docker и Docker Compose
- Учётная запись MongoDB Atlas

### Локальный запуск
1. Склонируйте текущий репозиторий с модифицированным кодом:
   ```bash
   git clone https://github.com/AgroxOD/agrmcs.git
   ```
   Каталог `bot` уже содержит необходимые исходники.
2. Перед запуском создайте файл `.env` на основе `.env.example`:
   ```bash
   cp .env.example .env
   ```
   Далее заполните переменные, например `MONGO_DATABASE_URL`, `APP_URL`, `PORT` и `HOST_PORT`.
   Переменная `LOCALE` определяет язык панели администратора (по умолчанию `en`).
3. В переменную `CHAT_ID` запишите ID чата для уведомлений. Его можно узнать через бота `@userinfobot`.
4. Запустите контейнеры:
   ```bash
  docker-compose up --build
  ```
  Compose соберёт образ бота и запустит MongoDB.
  Мини‑приложение открывается ссылкой из команды `/app`.
  При занятости порта 3000 укажите другой `HOST_PORT` в `.env`.

При необходимости можно собрать единый образ из корневого `Dockerfile`:
```bash
docker build -t task-manager .
docker run --env-file .env -p ${HOST_PORT:-3000}:${PORT:-3000} task-manager
```

### Развёртывание на [Pella](https://www.pella.app)
1. Свяжите репозиторий с сервисом и создайте приложение.
2. Выберите Node `20` или другую поддерживаемую версию.
3. Рабочая директория должна содержать `Procfile`. По умолчанию он лежит в
   корне и запускает команду `web: npm --prefix bot start`. Если директория
   `bot` используется отдельно, поместите `Procfile` внутрь неё с той же
   командой.
4. Перенесите значения из `.env.example` в настройки окружения.
5. Нажмите Deploy и дождитесь успешного запуска.

### Подробная инструкция для Pella
1. На панели управления создайте приложение и подключите репозиторий.
2. `Procfile` задаёт команду запуска, дополнительных шагов не требуется.
3. В разделе окружения добавьте переменные из `.env.example`.
4. Сохраните параметры и запустите Deploy. Спустя пару минут сервис станет доступен.

## Структура проекта
```
project-root/
├── ROADMAP.md          # план разработки
├── CHANGELOG.md        # история версий
├── bot/                # исходный код Telegram-бота
│   └── Dockerfile      # контейнер бота
├── .env.example        # пример переменных
├── .env                # локальные переменные (не добавляйте в git)
├── docker-compose.yml  # локальное развертывание
└── README.md           # документация
```

## Лицензия
Проект распространяется под лицензией MIT.

## CI с Docker
Файл `.github/workflows/docker.yml` проверяет `docker-compose.yml` и собирает образы при каждом pull request.

## Безопасность
Файл `.env` содержит секреты и предназначен только для локальной разработки.
Создайте его на основе `.env.example` и не публикуйте в репозитории.
Для продакшена рекомендуем использовать Docker Secrets или сторонние хранилища
секретов, например [Vault](https://www.vaultproject.io/).

## Резервное копирование БД в R2
Для создания архива MongoDB и загрузки его в R2 выполните:
```bash
./scripts/backup_mongo_r2.sh
```
Скрипт использует переменные из `.env` и требует установленный `aws` CLI.

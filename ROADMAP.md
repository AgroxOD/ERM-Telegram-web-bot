<!-- Назначение файла: краткий план развития проекта. -->

# Дорожная карта проекта

- Документация собрана в одном файле technical_manual.md

1. Подготовка окружения: `.env` из `.env.example`, запуск Docker Compose
2. Развитие бота и мини‑приложения в каталоге `bot`
3. Исправлена сборка CSS для стабильного дизайна
4. Автоматические тесты через `./scripts/setup_and_test.sh` локально и в CI; при наличии Docker проверяется `docker compose config`, иначе выводится предупреждение
5. Аудит зависимостей командой `./scripts/audit_deps.sh`
6. Слабые уязвимости пропускаются флагом `--audit-level high`
7. Скрипт `install_bot_deps.sh` завершает установку,
   если остаются только нерешённые слабые уязвимости
8. Проверка MongoDB скриптом `check_mongo.cjs`, использование healthcheck в Docker
9. Поддержка pm2 6.0.8 и повторных подключений к базе
10. Настройка fork-режима pm2 для предотвращения ошибок polling
11. Синхронизация команд и сообщений скриптами при деплое
12. Расширение API и интерфейса по мере необходимости
13. Интерфейс админки на `/cp` построен на TailAdmin
14. Доступ к админке открыт только пользователям с ролью администратора
15. Авторизация кодом из Telegram определяет роль пользователя автоматически
16. Маска доступа хранится в поле `access` и ускоряет проверку прав
17. В коллекции `roles` хранится список прав; страница `/cp/roles` позволяет их менять
18. Страница `/cp/logs` показывает логи через WG Log Engine
19. Цветные уровни и Telegram-уведомления о предупреждениях и ошибках
20. Пагинация списка задач для уменьшения нагрузки на клиент
21. Автоматическое формирование `slug` для человекочитаемого URL
22. Улучшение SEO и доступности (robots.txt, aria‑label, meta description)
23. Расширенная модель задачи с логистикой, закупками и работами
24. Поддержка enum-полей для типов транспорта, оплаты и статусов
25. CRUD-эндпойнты `/api/v1/tasks` с полной формой заявки
25. Учёт этих полей в веб-клиенте и контроллерах
26. Запрос `updateTask` фильтрует поля обновления, предотвращая инъекции
27. Значения enum задаются в `taskFields.cjs`, страница справочников удалена
28. Улучшение интерфейса управления заявками
29. Расширение enum-значений: добавлены "Построить", "Починить" и "Без оплаты"
30. Уточнение документации о допустимых значениях `task_type`
31. Унификация формы создания и редактирования задач
32. Везде использовать идентификатор вида `ERM_000001` и добавлять его к названию
33. Форма задач: сначала дата начала и срок выполнения, затем статус и приоритет, контролёр допускает несколько значений
34. Кнопки "Карта" ведут на ссылку <https://maps.app.goo.gl/xsiC9fHdunCcifQF6> без iframe
35. Бот отвечает полной ссылкой и координатами на короткие URL Google Maps
36. Форма задач принимает короткие ссылки Google Maps и сохраняет полные
37. Исполнители и контролёр добавляются из выпадающего списка через кнопку «+»
38. Поле ввода ссылки на карту скрывается после вставки, показывается адрес
39. Координаты сохраняются в `startCoordinates` и `finishCoordinates`
40. В форме под ссылкой отображаются координаты
41. Пустые координаты не передаются в API
42. Добавить поле `start_date` для даты начала задачи
43. Форма выравнивается слева и растягивается на всю ширину
44. Выпадающие списки упоминаний удалены
45. Унифицирован префикс /api/v1 во всех запросах клиента
46. Интеграция React Quill и TelegramUI через @telegram-apps/sdk-react
47. Запуск мини-приложения в браузере по флагу `?browser=1`; кнопка «Браузер» ведёт на `https://agromarket.up.railway.app/?browser=1`
48. Клиент автоматически выбирает режим работы при отсутствии `Telegram.WebApp`
49. Удалить неиспользуемые состояния `roles` и `groups` в `TaskDialog`
50. Вынести React-контексты в отдельные файлы для поддержки hot reload
51. В логах разработки выводить только начало `BOT_TOKEN`
52. Указать рабочий email в SECURITY.md и владельца в CODEOWNERS
53. Обновить документацию: приоритет по умолчанию — «В течение дня»
54. Экспортировать провайдеры контекстов из файлов контекста для надёжного импорта
55. Открывать форму задачи поверх текущей страницы по параметрам URL
56. Добавить возможность скрывать сайдбар на всех устройствах
57. Уточнить стили формы для мобильных экранов
58. Шапка учитывает ширину сайдбара и растягивается при его скрытии
59. Форма задач заполняет область под шапкой и центрируется
60. Отправка формы авторизации клавишей Enter
61. Поле "Название" находится в начале формы задачи
62. Некоторые поля формы размещены на одной строке для уменьшения высоты
63. Все ответы бота собраны в `docs/bot_responses.md` и представлены на русском
64. Скрипт `scripts/db/seed.js` использует приоритет «Срочно» для тестовой задачи
65. Списки значений загружаются из `taskFields.cjs` без вызова API
66. Страница `/tasks` показывает даты начала и завершения,
    админ может менять статус и приоритет прямо в таблице,
    доступна сортировка по всем колонкам
67. Эндпойнт `/api/v1/route` возвращает координаты и длину маршрута
68. Инструкция по запуску OSRM на Railway в docs/orsm.md
69. Пример переменной `ROUTING_URL` использует сервис `https://orsm-production.up.railway.app/route`
70. Фронтенд использует переменную `VITE_ROUTING_URL` с тем же адресом
71. README содержит пример JSON с координатами
72. В мануале к боту описано разворачивание коротких ссылок Google Maps
73. Документ `docs/railway_full_setup.md` описывает развёртывание всего проекта на Railway
74. В задачи добавлено поле `route_distance_km` для расстояния маршрута
75. Ссылка маршрута сохраняется в поле `google_route_url`
76. Новый API `/api/v1/routes/all` и страница «Маршруты» с картой
77. Параметр `status` в этом API проверяется как строка и передаётся в запрос без операторов
78. Leaflet подключён локально, политика CSP разрешает тайлы OpenStreetMap
79. Статусы задач переведены на русский, время выполнения сохраняется в `completed_at`
80. Политика CSP разрешает подключение к сервису OSRM
    и домену `router.project-osrm.org`
81. Фильтры маршрутов отправляются только при заполнении
82. Страница `/tasks` автоматически обновляет список после создания задачи,
    добавлена кнопка «Обновить задачи»
83. Задачи на этой странице создаются через `/api/v1/tasks` с полями `title`
    и `task_description`
84. Страница маршрутов строит путь через OSRM,
    задачи задают порядок отображения маршрутов
85. Карта занимает верхнюю часть страницы, таблица задач закреплена снизу
86. Старт и финиш маршрута отмечены интерактивными иконками,
    фильтры статуса удалены, задачи выводятся таблицей,
    администратор может открывать их на редактирование
87. Форма задачи всегда поверх карты, есть кнопка сброса изменений и возможность развернуть окно,
    администратор может удалить задачу с подтверждением
88. При открытии задачи ввод блокируется, для изменений есть кнопка «Редактировать»
89. В Tailwind настроены палитры `success`, `error` и `warning` для оформления кнопок и уведомлений
90. Реализована оптимизация маршрутов для 1–3 машин, на странице «Маршруты» добавлена кнопка «Просчёт маршрута»
91. Возле неё появился выбор метода: angle или trip
92. Маршруты отображаются поверх карты разными цветами, есть кнопка «Сбросить»
93. Меню расчёта находится между картой и списком задач
94. Ссылки Google Maps показываются в меню и не открываются автоматически
95. Если выбрано несколько машин, задачи распределяются между всеми авто
96. Удалённые задачи переносятся в коллекцию `archives` с номером вида `ERM_xxx-DEL`
97. Страница `/tasks` позволяет скачать таблицу задач в CSV или JSON
98. Кнопки действий задачи закреплены внизу внутри формы, цвет «Принять» и «Выполнено» зависит от статуса
99. Команда `/task_form_app` отправляет ссылку на форму создания задачи
100. Все изменения задач фиксируются в коллекции логов
101. `authFetch` перенаправляет на `/login` при отсутствии токена или статусе 401/403
102. Срок действия JWT увеличен до семи дней
103. Подтверждение кода админа обновляет роль существующего пользователя на `admin`
104. Исправлена ошибка линтера в `TaskDialog`: состояние `selectedAction` подсвечивает выбранную кнопку
105. Сервис OSRM поддерживает `/table`, `/nearest`, `/match` и `/trip`
106. Координаты запросов к маршрутам проходят валидацию
107. Подключение к MongoDB повторяется до 10 раз,
     параметры задаются переменными `RETRY_ATTEMPTS` и `RETRY_DELAY_MS`
108. Меню задач выводит только кнопку «Мои задачи», действия обновляют сообщение, не закрывая его
109. Кнопки «Выполнено» и «Отменить» обновляют статус задачи без повторного выбора
110. Кнопка «Мои задачи» и команда `/list_tasks` показывают все связанные задачи с кнопками действий
111. Команда `/task_info` выводит компактную форму задачи в чате
112. Задача отображается в формате Markdown, снизу кнопка «Маршрут»
113. В сообщении указаны тип задачи, дата начала, исполнители и создатель
114. Все запросы к API и ответы фиксируются в журнале
115. Бот сравнивает текст перед редактированием сообщений
116. Поля описания задач и комментариев ограничены 4096 символами
117. Описание задачи видно в форме при закрытом редакторе
118. Функция `stripTags` полностью удаляет HTML-теги из комментариев
119. В Telegram выводится поле `task_description` вместо `comment`
120. Превью ссылок в сообщениях задач отключается
121. Зависимость `glob` закреплена на версии 7.2.3 для совместимости с CommonJS

122. Меню бота содержит только команды /start и /register
123. Маршрут `/cp/admin` объявлен как `/*splat` для Express 5
124. Комментарии API обновлены для нового синтаксиса маршрутов
125. Перед обновлением зависимостей выполняйте `npm outdated`, затем
     `./scripts/audit_deps.sh` и `./scripts/setup_and_test.sh`
126. Поле username в ответах API содержит Telegram ID
127. ID пользователей показываются в интерфейсе ссылкой с именем.
128. В задачах имена исполнителей и контролёров отображаются ссылками на профиль
129. `authFetch` перенаправляет на `/login` при отсутствии токена или статусе 401/403
130. Запросы `/api/v1/users` и `/api/v1/departments` выполняются только администратором
131. Исправлена ошибка инициализации переменной isAdmin в TasksPage
132. Панель управления доступна по пути `/cp`, кнопка «Админка» расположена в шапке.
133. В ответах API добавлено поле `telegram_username` для отображения имени.
134. Заглушка аватара заменена иконкой `UserCircleIcon`.
135. При вводе админского кода роль пользователя обновляется на `admin`.
136. Исправлены ошибки ESLint в контроллерах routes и tasks
137. Исправлена загрузка списка пользователей в TasksPage для обычных пользователей
138. Загрузка задач в канбане корректно парсит ответ сервера
139. Имена исполнителей и контролёров в форме отображаются после подгрузки пользователей
140. Добавлены тесты админских маршрутов
141. Исправлено обновление роли на страницах задач при смене токена
142. Покрыт тестами доступ к `/api/v1/users`
143. Скрипт create_admin_user.js устанавливает roleId администратора
144. createUser проставляет name и roleId по умолчанию
145. Добавлен docs/architecture.md с кратким описанием модулей
146. Настроен Prettier и команда `npm run format`
147. В telegramApi.call реализован экспоненциальный бэкофф
148. Создан INCIDENT_RESPONSE.md для экстренной смены токена
149. Исправлена обработка кэша задач в tasks.js
150. Workflow CI закрепляет Node.js 20 и запускает тесты
151. Админка принимает токен через параметр `?token`,
     статические файлы отдаются без проверки
152. При ошибке 409 бот ждёт 3 секунды и перезапускается до пяти раз
153. Форма задачи остаётся открытой после сохранения, имена исполнителей сохраняются
154. Обновлены package-lock.json клиента для успешной сборки Docker
155. JWT теперь хранится в cookie HttpOnly
156. API использует lusca.csrf и express-session для защиты от CSRF
157. Сессия передаёт cookie только по HTTPS в продакшене, маршруты задач лимитированы
158. CSRF-токен находится в cookie XSRF-TOKEN и автоматически отправляется authFetch
159. Маршруты `/api/v1/auth/send_code` и `/api/v1/auth/verify_code` не требуют CSRF-токена
160. Сессии хранятся в MongoDB через библиотеку connect-mongo
161. Тесты используют secure cookie только в продакшене
162. Обновлена зависимость form-data до 4.0.4
163. Тест errorHandler использует secure cookie в зависимости от `NODE_ENV`
164. Реализовано кеширование в Redis, метрики Prometheus и пример Chaos testing
165. Добавлен маршрут `/api/v1/auth/verify_init` для проверки initData
166. В каталог `prometheus` помещены примеры конфигурации и оповещений
167. Создан файл `docs/stress_plan.md` с инструкцией по нагрузочному тестированию
168. Redis запускается отдельным контейнером `docker run -d --name redis -p 6379:6379 redis:alpine`
169. Добавлен маршрут `/api/v1/csrf` для получения CSRF-токена и метрика `csrf_errors_total`
170. Клиент при инициализации запрашивает `/api/v1/csrf` для установки CSRF-токена
171. authFetch повторяет запрос при ошибке CSRF и пишет исключение в консоль
172. AuthProvider ждёт загрузки профиля, чтобы исключить лишние редиректы на `/login`
173. При отсутствии CSRF-токена authFetch получает его перед отправкой запроса
174. API слушает PORT на 0.0.0.0, Railway перенаправляет HTTP на HTTPS
175. Уровень логирования по умолчанию debug, переменные `LOG_LEVEL`,
     `LOG_TELEGRAM_TOKEN` и `LOG_TELEGRAM_CHAT` необязательны
176. Схема логов принимает уровни debug и log для обработки console.log
177. Маршрут `/api/v1/optimizer` исключён из CSRF-проверки
178. Workflow CI выполняет линт, тесты и сборку клиента
179. В `CHANGELOG.md` описан процесс релизов и семантического версионирования
180. `docs/stress_plan.md` дополнен чек-листом отказоустойчивости

<!-- Назначение файла: план развития проекта. -->

# Дорожная карта проекта

Каталог `bot` содержит логику Telegram-бота и мини‑приложение,
отвечающее за приём задач и их обработку.
Каталог `admin` удалён, весь функционал реализован в мини‑приложении.

Ниже описан общий план развития этих модулей.

## 1. Подготовительный этап

- Клонирование репозитория.
- Создание файла `.env` и настройка переменных.
- Автоматизация генерации `.env` скриптом `create_env_from_exports.sh`, который
  берёт значения из текущего окружения и заполняет отсутствующие дефолтами из
  `.env.example`.

## 2. Интеграция

- Настройка общего Dockerfile и Compose для запуска обоих сервисов.
- Проверка локального запуска, устранение ошибок сборки.
- При возникновении ошибки `lstat /client` убедитесь, что Docker собирает
  образ из каталога `bot` и в нём присутствует папка `client`.
- Переход на MongoDB Atlas для хранения данных.
- Интеграция с облачным хранилищем R2.

- Добавление нового функционала бота и мини‑приложения.
- Тестирование и оптимизация.

- Использование платформы [Railway](https://railway.com) для публикации сервисов.
- Установка нового CLI `@railway/cli` и проверка `railway status` перед каждым PR.
- При ошибке `connect ENETUNREACH` задавайте `HTTP_PROXY`/`HTTPS_PROXY` или скачивайте CLI с GitHub Releases.
- Конфигурация CI/CD (например, GitHub Actions).
- Добавить сборку фронтенда в Procfile, чтобы исключить ошибку 404 при деплое.
- Проверять наличие каталога `bot/public` после сборки для устранения ошибки 404 на `/dashboard`.
- При пустой директории `bot/public` API теперь запускает `npm run build-client` автоматически.
- При использовании Railway отслеживать логи на наличие 404 и в случае ошибки повторять `npm --prefix bot run build-client`.
- Если в логе сервиса виден запрос `GET /dashboard/` со статусом 404, это признак отсутствия статических файлов; выполните сборку повторно.
- После обновления зависимостей перед каждой сборкой интерфейса выполняйте `npm --prefix bot/web install`.
- При возникновении предупреждений npm об устаревших пакетах обновляйте их сразу,
  чтобы избежать будущих конфликтов. Актуальные версии указаны в `package.json`.
- В `bot/web/next.config.ts` включите `trailingSlash`, чтобы страницы вроде `/dashboard` работали после обновления.
- Для диагностики сохраняйте вывод сборки:
  ```bash
  npm --prefix bot/web install > /tmp/npm_install.log 2>&1 && tail -n 20 /tmp/npm_install.log
  npm --prefix bot run build-client > /tmp/npm_build.log 2>&1 && tail -n 20 /tmp/npm_build.log
  # или ./scripts/build_client.sh
  ```

## В разработке

- Создан общий модуль `bot/src/db/queries.js` для работы с MongoDB.
- Добавлена карта запросов `docs/db_request_map.md`.
- Перенос фронтенда на React + Vite + Tailwind завершён.
- Tailwind config обновлён по шаблону TailAdmin 1.3, подключены все используемые шрифты.
- Обновлён плагин `@tailwindcss/postcss` до версии 4.1.11, что стабилизировало сборку CSS.
- Удалена директива `@custom-variant dark`, что исправило предупреждения esbuild при сборке стилей.
- Продолжается адаптация страниц под стиль TailAdmin, обновлена страница `Tasks` с таблицей и формой.
- Форма создания задачи включает выбор стартовой и финальной точек на карте, список типов и упоминание пользователей Telegram.
- Форма создания задачи использует кнопку «Карта» для выбора стартовой и финальной точек. Скопированная ссылка «Поделиться» преобразуется в короткий адрес со ссылкой на Google Maps. Новые ссылки сохраняются в базе.
- Для валидации ссылок Google Maps добавлена утилита `validateURL` с библиотекой `validator`.
- Мини‑карта загружается через ссылку `maps/embed`, Google не отправляет `X-Frame-Options`. В `helmet` прописан `frame-src https://www.google.com`.
- Внедрено модальное окно просмотра и редактирования задачи, открывающееся по клику на название.
- Форма создания задачи дополнена выбором приоритета, автора, списка исполнителей и полем комментария с упоминанием групп и ролей.
- Формы пользователей и проектов переведены на компоненты TailAdmin, добавлены утилиты кнопок.
- Настроены Jest и Supertest, добавлена интеграция Husky с `eslint` и тестами.
- Подключён Swagger для генерации документации API.
- Запущен CI на GitHub Actions с проверкой линтера и тестов.
- Исправлены цвета текста событий календаря в тёмной теме.
- Исправлены цвета текста в выпадающих меню, хлебных крошках и вкладках при активной тёмной теме.
- Добавлены скрипты миграций и сидов MongoDB.
- Создана простая админ‑панель управления пользователями и логами.
- Скрипт миграций теперь удаляет старый индекс `email_1`,
  регистрация через `/register` использует upsert.
- Запросы к задачам централизованы в сервисе `bot/web/src/services/tasks.js`.
- Реализован сценарий `crystal:loop` для автоматической кристаллизации всего кода.
- Цикл выполняется, пока средний уровень не превысит 99%.
- Подготовлено расширенное руководство по адаптации дизайна TailAdmin (docs/extended_tailadmin_guide.md).
- При ошибке `ERR_UNKNOWN_FILE_EXTENSION` запускайте `npm run crystal:auto-update`.
- Регистрация через `/api/auth/register` сразу выдаёт JWT,
  интеграционные тесты покрывают оба маршрута регистрации и входа.
- Бот отправляет ссылку на мини‑приложение после `/start`,
  команда `/app` остаётся опциональной.
- Разработан Figma-документ, полностью повторяющий TailAdmin, см. `docs/tailadmin_figma_design.md`.
- Сам файл `TailAdminDesign.fig` хранится в каталоге `docs` и применяется при верстке.
  Дизайн включает светлую и тёмную темы, компоненты оформлены как Variants в Figma.
  Файл в репозитории является заглушкой; полная версия дизайна доступна во внешнем хранилище.
- В ходе обновления зависимостей устранены предупреждения npm об устаревших
  модулях, включая `lodash.isequal` и `glob`.
- Для обновления бейджа README используется `crystal:update-badge`, файл кристаллизации можно синхронизировать командой `crystal:sync`.
- Скрипт `crystal:auto-update` проверяет `https://api.github.com/repos/AgroxOD/crystallization-development/commits` и при появлении нового коммита обновляет `crystallizationManager.ts`.
- Расширена валидация API и добавлены разделы "Логи" и "Роли" во фронтенде.
- Для раздела "Роли" реализована форма создания роли, страница "Логи" выводит последние события из MongoDB.
- Интерфейс страницы `Роли` приведён к стилю TailAdmin.
- Продолжается работа над мелкими элементами TailAdmin: добавлены dropdown меню профиля, вкладки, пагинация и breadcrumbs.
- На Dashboard добавлены skeleton‑карточки и плавная загрузка таблицы последних задач.
- Добавлен контекст Toast и компонент `Toasts` для одновременного отображения нескольких уведомлений.
- Исправлена регистрация через Telegram: поле `email` теперь генерируется автоматически
  в формате `<telegram_id>@telegram.local`, что устранило конфликт уникального индекса.
- Базовая конфигурация ESLint размещена в `eslint.config.js`, команды `npx eslint bot/src` проверяют серверный код.
- При ошибке `Cannot find module '@eslint/js'` перед запуском линтера выполняйте `npm --prefix bot install`.
- Для воспроизводимой установки используйте `npm ci --prefix bot`. При отсутствии `package-lock.json` запустите `npm --prefix bot install` для его создания. После установки выполняйте `npm audit fix --prefix bot` или скрипт `scripts/install_bot_deps.sh`.
- В API добавлены `helmet`, `cors` и проверка полей через `express-validator`.
- Маршруты регистрации и входа теперь валидируют данные через `express-validator`.
- Реализован fallback маршрута `app.get('/{*splat}')` для корректной работы SPA.
- Убраны устаревшие маршруты `/tasks`; путь к задачам только `/api/tasks`, что
  устранило ошибку `{"message":"No token provided"}` при перезагрузке страниц.
- Для этого маршрута добавлен rate limiter во избежание атак.
- Маршрут `/api/tasks/:id` также имеет лимит 100 запросов за 15 минут.
- Путь `/api/auth/login` допускает 5 попыток в минуту для защиты от брутфорса.
- Маршруты `/api/groups`, `/api/users`, `/api/roles`, `/api/logs` и
  `/api/tasks/:id/status` ограничены тем же лимитом 100 запросов за 15 минут.
- Для чтения переменных окружения создан модуль `bot/src/config.js`.
- Подключение к MongoDB вынесено в `bot/src/db/connection.js` с пулом соединений.
- Устаревшие опции `useNewUrlParser` и `useUnifiedTopology` убраны из подключения
  к базе, чтобы драйвер не выводил предупреждения.
- Для PostCSS в React‑фронтенде используется плагин `@tailwindcss/postcss`.
- Во фронтенд добавлен Prettier и градиентный фон из шаблона React Vite Tailwind.
- Подготовлена инструкция `docs/dashboard_tailadmin.md` по применению стилей TailAdmin для страницы Dashboard.
- В интерфейс интегрирован дизайн TailAdmin: появились страницы "Проекты", "Отчёты" и "Профиль", сохранён компонент NotificationBar.
- NotificationBar дополнен иконкой и кнопкой закрытия, график TasksChart использует фирменные цвета и поддерживает тёмный режим.
- Стили обновлены из архива `free-react-tailwind-admin-dashboard-main.zip`, дизайн ближе к демо TailAdmin.
- Улучшены страницы входа, регистрации и профиля, логика вынесена в контекст AuthContext.
- Формы входа и регистрации отображают спиннер загрузки и выводят ошибки через Toast.
- Добавлена доска Kanban для задач с drag&drop.
- Исправлена ошибка линтера в компоненте Kanban.
- Статусы задач приведены к `new/in-progress/done`, что устраняет 500 ошибки.
- Все тесты и линтер выполняются без ошибок.
- Добавлены тесты `kanbanStatus` и `authRole` для проверки статуса задач и ролей.
- В AuthContext при ошибке запроса профиля токен стирается из `localStorage`,
  чтобы избежать постоянных 401 и переадресовать пользователя на логин.
- При ответе 401 или 403 на `/api/tasks` пользователь переходит на страницу входа.
- Drag&drop переведён на `@hello-pangea/dnd` с поддержкой React 19.
- Реализована страница `Task List` по адресу `/tasks`, дизайн повторяет демо TailAdmin.
- На страницах "Админ", "Проекты" и "Отчёты" добавить формы для создания пользователей,
  групп и фильтрации отчётов.
- Эти страницы оформлены карточками TailAdmin, сверху отображаются breadcrumbs.
- Breadcrumbs внедрены на Dashboard, странице профиля и отчётов.
- Добавлено выпадающее меню уведомлений в шапке.
- Настроен релизный workflow с Docker-сборкой и командой `railway up`.
- Добавлен скрипт `scripts/audit_dependencies.sh` для `npm audit` и `npm outdated`.
- При появлении предупреждений GitHub обновляем зависимости командой
  `npm --prefix bot audit fix --force` и проверяем `npm --prefix bot outdated`.
- При установке зависимостей используем `npm ci --prefix bot || npm --prefix bot install`, затем `npm audit fix --prefix bot` или используем скрипт `scripts/install_bot_deps.sh`.
- Расширяем документацию по сценарию использования API.
- Настроен workflow `release.yml` для автоматических GitHub Releases.
- Внедрена система "кристаллизации" задач и CLI `crystallizationManager.ts`.
- Добавлен маршрут `/api/tasks/:id` для получения одной задачи.
- Реализован метод `DELETE /api/tasks/:id` и кнопка удаления задачи в интерфейсе.
- Обновлены ссылки на workflow Docker и Release в README.
- Маршруты `/groups`, `/users`, `/roles` и `/logs` перенесены под префикс `/api`.
- Статус задач изменяется через `/api/tasks/:id/status`.
- Добавлен шаблон pull request и файл CODEOWNERS.
- Создан issue template `task.yml` для универсальных задач.
- В модель пользователя добавлено поле `roleId`, права проверяет middleware `checkRole`, роль выбирается при создании пользователя.
- Интегрируем дополнительные возможности Telegram Bot API через `telegramApi.js`.
- Подготовлена инструкция по настройке бота через BotFather и добавлен скрипт `scripts/set_bot_commands.sh` для загрузки команд.
- Бот через команду `/start` автоматически создаёт пользователя в базе и предоставляет админам команды `/list_users` и `/add_user`.
- Коллекция пользователей бота переименована в `telegram_users`,
  что устранило ошибку уникального индекса `email` при регистрации.
- Описаны лучшие практики CI/CD в разделе README.
- Во фронтенд добавлены компоненты Sidebar, Header и DashboardPage из TailAdmin на TypeScript.
- Настроен TypeScript в каталоге `bot/web` и подключён tsconfig.
- Интерфейс полностью адаптирован к дизайну TailAdmin с использованием `@heroicons/react`.
- Для стабильной работы React добавлена зависимость `@heroicons/react` и проверка наличия элемента `#root` в `main.tsx`.
- Исправлена ошибка `Minified React error #130`: элементы меню теперь содержат поле `icon`.
- Dashboard отображает метрики задач и график активности за неделю.
- Интегрирован полноценный Dashboard с KPI‑карточками, графиком и таблицей последних задач.
- Реализован модуль задач с чеклистами, тайм‑трекером и KPI.
- Отчёты KPI поддерживают фильтр по дате через `from` и `to`.
- Введён контроллер `reportController.js` для агрегирования отчётов.
- Добавлена система регистрации и входа пользователей, страница профиля на React.
- Настроен workflow `ci.yml` с MongoDB для проверки серверных и фронтенд тестов.
- В нём для бэкенда используется `./scripts/install_bot_deps.sh`.
- Написаны тесты безопасности и проверки rate limit для маршрутов API.

## 5. Отслеживание версий

- Для каждой версии фиксировать изменения в файле `CHANGELOG.md`.
- Помечать релизы git-тегами вида `vX.Y.Z`.

## 6. Документация и безопасность

- После релиза обновлять `README.md` и `SECURITY.md`.
- Проверять конфигурацию `docker-compose.yml` командой `docker compose config`.
- Перед этим убедитесь, что создан файл `.env`, иначе проверка завершится ошибкой.

## 7. Поддержка зависимостей

- Периодически выполнять `npm audit` и `npm outdated` для модуля `bot`.
- Обновлять пакеты после успешного прохождения тестов.
- В актуальной версии обновлены `@aws-sdk/client-s3` и `jest`.
- Также обновлены транзитивные зависимости, чтобы убрать предупреждения npm о пакетах `lodash.isequal`, `lodash.get`, `inflight` и `glob`.
- Для полного устранения предупреждения `inflight` добавлен override `glob@11` в `bot/package.json`.
- Использовать скрипт `scripts/audit_dependencies.sh` для автоматизации проверки.
- При обнаружении уязвимостей запускать `npm audit fix --prefix bot`. Используйте также `scripts/install_bot_deps.sh` для установки.
- При возникновении ошибок сети при обращении к `nextjs.org` убедитесь в наличии интернет‑доступа или настройте прокси.
- Если `npm` выводит предупреждение `Unknown env config "http-proxy"`, его можно игнорировать либо удалить переменные `http_proxy` и `https_proxy` из окружения.

- Добавлена документация с результатами Lighthouse (docs/lighthouse_20250624.md).
- Добавлен свежий отчёт Lighthouse за 26.06.2025 (docs/lighthouse_20250626.md).
- Разработан `ToastProvider` для отображения стека уведомлений во фронтенде.
- Обновлён `bot/web/package-lock.json`, ошибка `npm ci` из-за отсутстсвия validator устранена.
- Внедрён общий helper authFetch, предотвращающий ошибку 'No token provided' при обновлении страниц.
- Фронтенд разбит на чанки через `React.lazy`, что уменьшило размер главного бандла.
- Исправлены предупреждения React Hooks на Dashboard и TasksPage.
- Переключение светлой и тёмной темы теперь учитывает системную настройку браузера.
- В index.html подключён скрипт `theme.js`, который добавляет класс `dark` перед инициализацией React, устраняя мерцание и обходя ограничения CSP.



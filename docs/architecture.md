<!-- Назначение файла: обзор архитектуры и модулей проекта (Auth, Tasks, Users, Roles, Logs). -->

# Архитектура

## Цель проекта
Перейти от монолитного JavaScript‑кода к модульной архитектуре на TypeScript,
используя Express и MongoDB. Структура вдохновлена подходами NestJS:
чёткое разделение слоёв, DTO‑валидация и декораторы для RBAC.

## Структура каталогов

```
src/
  common/
  decorators/
  guards/
  dto/
  error-handler.ts
  logger.ts
  modules/
    auth/
    tasks/
    users/
    roles/
    logs/
  config/
  app.ts
web/
```

## Технологии и подходы

- Express + TypeScript, MongoDB через Mongoose.
- Внедрение зависимостей через `tsyringe`.
- DTO и `class-validator` для валидации входных данных.
- Декораторы `@Roles` и guard `rolesGuard` для проверки маски доступа.
- Middleware для логирования и метрик Prometheus.

## Модульная структура

- **AuthModule** — аутентификация через Telegram, выдача JWT и CSRF‑токена.
- **TasksModule** — CRUD задач и расчёт маршрутов.
- **UsersModule** — управление пользователями.
- **RolesModule** — описание ролей и масок доступа.
- **LogsModule** — журналирование действий.

Модули связаны через сервисы и разделены по ответственности,
что упрощает тестирование и расширение функциональности.
Поле `access` модели пользователя хранит числовую маску для быстрой проверки прав.

## Этапы внедрения

1. Настроить DI‑контейнер и структуру модулей.
2. Создать DTO и middleware для валидации.
3. Реализовать декораторы и guards для RBAC.
4. Перенести авторизацию, затем Tasks, Users, Roles и Logs.
5. Подключить логирование и метрики Prometheus.
6. Покрыть код тестами.

## KPI

- Ошибки CSRF < 1 %.
- DTO‑валидация покрывает > 95 % POST/PATCH запросов.
- RBAC запрещает изменение чужих задач.
- Тестовое покрытие > 80 %.
- Логи фиксируют `userId` для каждого действия.

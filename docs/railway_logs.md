<!-- Назначение файла: автоматизация сбора, анализа и передачи логов деплоев Railway. -->

# Автоматизированный сбор и анализ логов деплоев Railway

Процесс построен так, чтобы вы выполнили только базовую настройку Railway, а далее скрипт сам выгружает логи, анализирует ошибки и запускает улучшения кода.

## 1. Что нужно сделать вручную
1. Настройте проект по краткому чек-листу из [railway_minimal_setup.md](./railway_minimal_setup.md).
2. Установите Railway CLI: `npm install -g @railway/cli`.
3. Создайте токен в Railway (Profile → **Account** → **Generate Token**) и выполните `railway login --token <значение>`.
4. Свяжите репозиторий с проектом: `railway link`.
5. Скопируйте конфигурацию конвейера: `cp Railway/config/pipeline.example.env Railway/config/pipeline.env` и задайте значения переменных.

На этом ручные действия заканчиваются.

## 2. Запуск полного конвейера
В корне репозитория выполните:

```bash
./scripts/railway_log_pipeline.sh
```

Скрипт последовательно:
- скачивает логи последнего деплоя (или указанного идентификатора);
- сохраняет их в `Railway/logs/<service>-<env>-<deploy>-<timestamp>.log`;
- запускает `scripts/analyze_railway_logs.mjs`, который формирует отчёт в `Railway/analysis` и подбирает корректирующие действия;
- автоматически выполняет безопасные команды (например, `pnpm lint`, `pnpm test:api`, `node scripts/check_mongo.mjs`).

Отчёт с расшифровкой ошибок и списком рекомендаций сохраняется в Markdown и JSON. Ссылки на созданные файлы выводятся в консоли.

## 3. Частые параметры
- `--deploy <id>` — проанализировать конкретный деплой.
- `--tail 800` — увеличить объём загружаемого лога.
- `--skip-improvements` — сформировать отчёт, но не запускать команды улучшений.
- `--dry-run` — показать последовательность действий без выполнения.
- `--output-dir ./tmp/analysis` — сохранить результаты в другой каталог.

Пример запуска для продакшна:

```bash
./scripts/railway_log_pipeline.sh --deploy latest --tail 600
```

## 4. Передача материалов ассистенту
1. Прикрепите файл отчёта из `Railway/analysis/*.md` и, при необходимости, исходный лог из `Railway/logs/`.
2. Добавьте команду запуска конвейера, чтобы можно было воспроизвести шаги.
3. Перед публикацией убедитесь, что в логах нет секретов. При необходимости удалите их вручную.

## 5. Если что-то пошло не так
- `Not authenticated` — повторите `railway login --token <значение>`.
- `Project not linked` — выполните `railway link` в корне репозитория.
- `No deployments found` — проверьте значение переменных `RAILWAY_SERVICE` и `RAILWAY_ENVIRONMENT` в конфигурации.
- Конвейер завершился с ошибкой — изучите `Railway/analysis/*` и вывод команд. При необходимости используйте `--skip-improvements`, чтобы получить отчёт без автоисправлений.
